---
import { Transition, Fade } from 'astro:transitions';
import Button from './ui/Button.astro';

interface Props {
  isOpen: boolean;
  onClose: () => void;
  title?: string;
  children: any; // Content to be rendered inside the modal
}

const { isOpen, onClose, title = "Modal Title", children } = Astro.props;

// Function to handle keyboard events for accessibility
const handleKeyDown = (event: KeyboardEvent) => {
  if (event.key === 'Escape') {
    onClose();
  }
};

// Client-side script to handle focus trapping and scroll locking
// This script will run on the client, so wrap in <script> and use client:load or similar
// For this component, it's simpler to manage directly in the page if it's a single modal
// or within the component if it's a framework component. For Astro components,
// inline script is often the most direct approach for simple client-side logic.
---

{isOpen && (
  <Transition name="modal-fade" animate={Fade}>
    <div
      role="dialog"
      aria-modal="true"
      aria-labelledby="modal-title"
      class="fixed inset-0 z-50 flex items-center justify-center p-4"
      tabindex="-1"
      onkeydown={handleKeyDown}
    >
      {/* Backdrop */}
      <div
        class="absolute inset-0 bg-black bg-opacity-70"
        onclick={onClose}
        aria-hidden="true"
      ></div>

      {/* Modal Content */}
      <div
        class="relative bg-surface rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
        role="document"
      >
        <div class="flex justify-between items-center p-4 border-b border-border">
          <h2 id="modal-title" class="font-heading text-xl font-semibold text-text-dark">
            {title}
          </h2>
          <Button
            type="button"
            variant="ghost"
            size="sm"
            aria-label="Close modal"
            onclick={onClose}
            class="text-text-muted hover:text-text-dark"
          >
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </Button>
        </div>
        <div class="p-4">
          <slot />
        </div>
      </div>
    </div>
  </Transition>
)}

<script>
  // Client-side script for focus trapping and scroll locking
  // This needs to be outside the Astro component definition if it's not a framework component
  // or use client:load on a small wrapper component
  document.addEventListener('astro:after-swap', () => {
    const modal = document.querySelector('[role="dialog"]');
    if (modal) {
      // Focus trapping
      const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstFocusableElement = focusableElements[0];
      const lastFocusableElement = focusableElements[focusableElements.length - 1];

      firstFocusableElement?.focus();

      modal.addEventListener('keydown', (e) => {
        const isTabPressed = e.key === 'Tab';
        if (!isTabPressed) {
          return;
        }

        if (e.shiftKey) { // if shift key pressed for shift + tab
          if (document.activeElement === firstFocusableElement) {
            lastFocusableElement?.focus(); // add focus to the last focusable element
            e.preventDefault();
          }
        } else { // if tab key is pressed
          if (document.activeElement === lastFocusableElement) {
            firstFocusableElement?.focus(); // add focus to the first focusable element
            e.preventDefault();
          }
        }
      });

      // Scroll locking
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = ''; // Re-enable scroll when modal is closed
    }
  });

  // Initial load for modals that might be open on page load
  const initialModal = document.querySelector('[role="dialog"]');
  if (initialModal) {
    document.body.style.overflow = 'hidden';
  }
</script>