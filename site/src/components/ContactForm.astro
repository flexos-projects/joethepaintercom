---
import Button from '@/components/ui/Button.astro';
import Input from '@/components/ui/Input.astro';
import Label from '@/components/ui/Label.astro';
import Textarea from '@/components/ui/Textarea.astro';

interface Props {
  ctaText?: string;
  formId: string; // Unique ID for the form, for reCAPTCHA and identification
}

const { ctaText = 'Send My Message', formId } = Astro.props;

const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;
---

<form id={formId} class="space-y-6 bg-white p-8 shadow-lg rounded-lg" data-form-type="contact">
  <h2 class="text-3xl font-heading font-bold text-neutral-800 mb-6">Send Joe a Message</h2>
  <p class="text-neutral-600 mb-8">
    Have a quick question or a general inquiry? Fill out the form below, and Joe will get back to you within 2 business days.
  </p>

  <div>
    <Label for={`${formId}-yourName`}>Your Name</Label>
    <Input
      type="text"
      id={`${formId}-yourName`}
      name="yourName"
      placeholder="Your Name"
      required
      aria-required="true"
      minlength="2"
      pattern="[A-Za-z\s]+"
      title="Name should only contain letters and spaces"
    />
    <p id={`${formId}-yourName-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please enter your name.</p>
  </div>

  <div>
    <Label for={`${formId}-yourEmail`}>Your Email</Label>
    <Input
      type="email"
      id={`${formId}-yourEmail`}
      name="yourEmail"
      placeholder="your.email@example.com"
      required
      aria-required="true"
    />
    <p id={`${formId}-yourEmail-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please enter a valid email address.</p>
  </div>

  <div>
    <Label for={`${formId}-subject`}>Subject</Label>
    <Input
      type="text"
      id={`${formId}-subject`}
      name="subject"
      placeholder="Regarding my project..."
      minlength="5"
      maxlength="100"
    />
    <p id={`${formId}-subject-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please enter a subject (min 5 characters).</p>
  </div>

  <div>
    <Label for={`${formId}-yourMessage`}>Your Message</Label>
    <Textarea
      id={`${formId}-yourMessage`}
      name="yourMessage"
      rows="5"
      placeholder="Type your message here..."
      required
      aria-required="true"
      minlength="10"
      maxlength="1000"
    ></Textarea>
    <p id={`${formId}-yourMessage-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please enter your message (min 10 characters, max 1000).</p>
  </div>

  <input type="hidden" name="g-recaptcha-response" id={`${formId}-recaptcha-response`} />

  <div id={`${formId}-status-message`} class="mt-4 p-3 rounded-md hidden" role="status"></div>

  <Button type="submit" size="lg" class="w-full" id={`${formId}-submit-btn`}>
    {ctaText}
  </Button>
</form>

<script is:inline define:RECAPTCHA_SITE_KEY={RECAPTCHA_SITE_KEY}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('{formId}');
    const statusMessage = document.getElementById('{formId}-status-message');
    const submitButton = document.getElementById('{formId}-submit-btn');

    const showMessage = (message, type = 'info') => {
      statusMessage.textContent = message;
      statusMessage.classList.remove('hidden', 'bg-error', 'bg-success', 'bg-warning', 'bg-info');
      statusMessage.classList.add(`bg-${type}`, `text-${type === 'success' ? 'success-dark' : type}-dark`); // Assuming semantic dark text colors
      statusMessage.style.display = 'block'; // Ensure it's visible
    };

    const hideMessage = () => {
      statusMessage.classList.add('hidden');
      statusMessage.style.display = 'none';
    };

    const validateField = (inputElement, errorElement, minLength, maxLength, pattern) => {
      if (!inputElement) return true; // Skip if element not found

      let isValid = true;
      let errorMessage = '';

      if (inputElement.required && !inputElement.value.trim()) {
        isValid = false;
        errorMessage = 'This field is required.';
      } else if (minLength && inputElement.value.trim().length < minLength) {
        isValid = false;
        errorMessage = `Minimum length is ${minLength} characters.`;
      } else if (maxLength && inputElement.value.trim().length > maxLength) {
        isValid = false;
        errorMessage = `Maximum length is ${maxLength} characters.`;
      } else if (pattern && !new RegExp(pattern).test(inputElement.value.trim())) {
        isValid = false;
        errorMessage = inputElement.title || 'Invalid format.';
      } else if (inputElement.type === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inputElement.value.trim())) {
        isValid = false;
        errorMessage = 'Please enter a valid email address.';
      }

      if (!isValid) {
        inputElement.classList.add('border-error');
        errorElement.textContent = errorMessage;
        errorElement.classList.remove('hidden');
      } else {
        inputElement.classList.remove('border-error');
        errorElement.classList.add('hidden');
      }
      return isValid;
    };

    const validateForm = () => {
      hideMessage();
      let isFormValid = true;

      isFormValid = validateField(form.elements[`${formId}-yourName`], document.getElementById(`${formId}-yourName-error`), 2, null, '[A-Za-z\\s]+') && isFormValid;
      isFormValid = validateField(form.elements[`${formId}-yourEmail`], document.getElementById(`${formId}-yourEmail-error`)) && isFormValid;
      isFormValid = validateField(form.elements[`${formId}-subject`], document.getElementById(`${formId}-subject-error`), 5, 100) && isFormValid;
      isFormValid = validateField(form.elements[`${formId}-yourMessage`], document.getElementById(`${formId}-yourMessage-error`), 10, 1000) && isFormValid;

      return isFormValid;
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!validateForm()) {
        showMessage('Please correct the errors in the form.', 'error');
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = 'Sending...';
      submitButton.classList.add('opacity-75', 'cursor-not-allowed');
      hideMessage();

      try {
        if (typeof grecaptcha !== 'undefined' && RECAPTCHA_SITE_KEY) {
          const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit_contact_form' });
          document.getElementById('{formId}-recaptcha-response').value = token;
        } else {
          console.warn('reCAPTCHA not loaded or site key missing. Submitting without reCAPTCHA token.');
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.formType = form.dataset.formType; // Add form type for backend differentiation

        const response = await fetch('/api/submit-form', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          showMessage('Thank You! Your message has been sent to Joe. He aims to respond within 2 business days.', 'success');
          form.reset(); // Clear form fields on success
        } else {
          showMessage(result.message || 'Oops! Something went wrong on our end. Please try again or call Joe directly at (760) 580-8173.', 'error');
        }
      } catch (error) {
        console.error('Form submission error:', error);
        showMessage('An unexpected error occurred. Please try again or call Joe directly at (760) 580-8173.', 'error');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = '{ctaText}';
        submitButton.classList.remove('opacity-75', 'cursor-not-allowed');
      }
    });

    // Add real-time validation feedback on blur
    form.elements[`${formId}-yourName`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-yourName-error`), 2, null, '[A-Za-z\\s]+'));
    form.elements[`${formId}-yourEmail`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-yourEmail-error`)));
    form.elements[`${formId}-subject`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-subject-error`), 5, 100));
    form.elements[`${formId}-yourMessage`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-yourMessage-error`), 10, 1000));
  });
</script>