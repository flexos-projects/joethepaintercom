---
import Label from './ui/Label.astro';
import Input from './ui/Input.astro';
import Textarea from './ui/Textarea.astro';
import Button from './ui/Button.astro';

interface Props {
  id?: string;
  formspreeEndpoint?: string; // Optional override, otherwise uses env var
  onSuccess?: string; // URL to redirect on success
}

const { id = 'contact-form', formspreeEndpoint, onSuccess = '/thank-you-contact' } = Astro.props;

// Use environment variable for Formspree endpoint, or provide a default if not set for dev
const endpoint = formspreeEndpoint || import.meta.env.FORMSPREE_ENDPOINT_URL || 'https://formspree.io/f/yourformid';
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;
---

<form id={id} method="POST" action={endpoint} class="space-y-spacing-4 bg-surface p-spacing-6 rounded-lg shadow-md">
  <input type="hidden" name="g-recaptcha-response" id={`${id}-recaptcha-response`} />

  <div>
    <Label for={`${id}-name`} required>Your Name</Label>
    <Input id={`${id}-name`} name="name" type="text" placeholder="Jane Doe" required autocomplete="name" />
  </div>

  <div>
    <Label for={`${id}-email`} required>Your Email</Label>
    <Input id={`${id}-email`} name="email" type="email" placeholder="jane.doe@example.com" required autocomplete="email" />
  </div>

  <div>
    <Label for={`${id}-phone`}>Your Phone (Optional)</Label>
    <Input id={`${id}-phone`} name="phone" type="tel" placeholder="(760) 555-1234" autocomplete="tel" />
  </div>

  <div>
    <Label for={`${id}-subject`} required>Subject</Label>
    <Input id={`${id}-subject`} name="subject" type="text" placeholder="Inquiry about painting services" required />
  </div>

  <div>
    <Label for={`${id}-message`} required>Your Message</Label>
    <Textarea id={`${id}-message`} name="message" rows={5} placeholder="Ask anything you'd like!" required />
  </div>

  <Button type="submit" variant="primary" size="lg" class="w-full">
    Send My Message
  </Button>
</form>

<script is:inline define:vars={{ formId: id, recaptchaSiteKey: recaptchaSiteKey, onSuccessUrl: onSuccess }}>
  const form = document.getElementById(formId);
  const recaptchaResponseInput = document.getElementById(`${formId}-recaptcha-response`);

  if (form && recaptchaResponseInput && recaptchaSiteKey) {
    form.addEventListener('submit', function (event) {
      event.preventDefault(); // Prevent default form submission

      if (typeof grecaptcha !== 'undefined' && grecaptcha.ready) {
        grecaptcha.ready(function() {
          grecaptcha.execute(recaptchaSiteKey, { action: 'submit_contact' }).then(function(token) {
            recaptchaResponseInput.value = token;
            form.submit(); // Submit the form after getting the token
          }).catch(function(error) {
            console.error('reCAPTCHA execution failed:', error);
            // Fallback: submit form without recaptcha token if it fails
            form.submit();
          });
        });
      } else {
        console.warn('reCAPTCHA script not fully loaded or ready. Submitting form without token.');
        form.submit(); // Fallback: submit form without recaptcha token
      }
    });
  } else {
    // This warning should only appear if PUBLIC_RECAPTCHA_SITE_KEY is not set (e.g., in development)
    // or if the DOM elements are missing.
    console.warn('reCAPTCHA integration skipped: form, recaptcha input, or site key missing. Ensure PUBLIC_RECAPTCHA_SITE_KEY is set in your .env file for production.');
  }
</script>