---
/**
 * TestimonialCarousel Component
 * Displays a rotating carousel of TestimonialCard components.
 * Features auto-play, navigation arrows, and dot indicators.
 * Designed for responsiveness and accessibility.
 */

// Type imports
import type { CollectionEntry } from 'astro:content';
// Ensure the Testimonial type from src/content/config.ts is correctly imported
// Assuming Testimonial is defined within the content config.
type TestimonialEntry = CollectionEntry<'testimonials'>;

// Component imports
import TestimonialCard from './TestimonialCard.astro';
import Icon from './ui/Icon.astro'; // Assuming Icon component is in ui folder

// Props interface with JSDoc comments
interface Props {
  /** An array of testimonial entries to display in the carousel. */
  testimonials: TestimonialEntry[];
}

// Destructure props
const { testimonials } = Astro.props;

// Ensure testimonials array is valid for rendering
if (!testimonials || testimonials.length === 0) {
  // In a production scenario, you might want to render a fallback,
  // log an error, or throw an exception. For this task,
  // we'll render an empty section if no testimonials are provided.
  // This ensures no runtime errors from null/undefined testimonials.
  console.warn('TestimonialCarousel received no testimonials to display.');
  // Return an empty fragment or a message if no testimonials.
  // For now, allow empty array to render an empty carousel structure.
}

const uniqueId = `testimonial-carousel-${Math.random().toString(36).substring(2, 9)}`;
---

<section id={uniqueId} class="testimonial-carousel-section" aria-label="Client Testimonials">
  <div class="container mx-auto px-4 py-12 md:py-20">
    <h2 class="text-center font-heading text-4xl leading-4xl font-bold text-text mb-10 md:mb-14">
      What Our Clients Say
    </h2>

    <div class="relative max-w-4xl mx-auto">
      <div id={`${uniqueId}-track-wrapper`} class="overflow-hidden rounded-lg">
        <div
          id={`${uniqueId}-track`}
          class="flex transition-transform duration-normal ease-in-out"
          role="region"
          aria-live="polite"
          aria-atomic="true"
          tabindex="0"
        >
          {testimonials.map((testimonial, index) => (
            <div
              class="w-full flex-shrink-0 px-2"
              role="group"
              aria-roledescription="slide"
              aria-label={`${index + 1} of ${testimonials.length}`}
              aria-hidden={index === 0 ? 'false' : 'true'}
              data-index={index}
            >
              <TestimonialCard
                quote={testimonial.data.quote}
                clientName={testimonial.data.clientName}
                clientLocation={testimonial.data.clientLocation}
                projectType={testimonial.data.projectType}
              />
            </div>
          ))}
        </div>
      </div>

      <!-- Navigation Arrows -->
      {testimonials.length > 1 && (
        <>
          <button
            id={`${uniqueId}-prev`}
            class="absolute top-1/2 -translate-y-1/2 left-2 md:left-4 z-10 p-3 rounded-full bg-surface shadow-md hover:bg-neutral-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary-light transition-colors duration-fast"
            aria-label="Previous testimonial"
          >
            <Icon name="arrow-left" class="w-5 h-5 text-primary" />
          </button>
          <button
            id={`${uniqueId}-next`}
            class="absolute top-1/2 -translate-y-1/2 right-2 md:right-4 z-10 p-3 rounded-full bg-surface shadow-md hover:bg-neutral-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary-light transition-colors duration-fast"
            aria-label="Next testimonial"
          >
            <Icon name="arrow-right" class="w-5 h-5 text-primary" />
          </button>
        </>
      )}

      <!-- Dots Indicator -->
      {testimonials.length > 1 && (
        <div class="flex justify-center mt-8 space-x-2" role="tablist" aria-label="Testimonial slides">
          {testimonials.map((_, index) => (
            <button
              id={`${uniqueId}-dot-${index}`}
              class:list={[
                'dot',
                'w-3 h-3 rounded-full hover:bg-primary-light transition-colors duration-fast',
                index === 0 ? 'bg-primary ring-2 ring-primary-light' : 'bg-neutral-300'
              ]}
              aria-label={`Go to slide ${index + 1}`}
              role="tab"
              aria-controls={`${uniqueId}-slide-${index}`}
              aria-selected={index === 0 ? 'true' : 'false'}
              tabindex={index === 0 ? '0' : '-1'}
              data-index={index}
            ></button>
          ))}
        </div>
      )}
    </div>
  </div>
</section>

<script is:inline define:vars={{ uniqueId }}>
  const carouselTrackWrapper = document.getElementById(`${uniqueId}-track-wrapper`);
  const carouselTrack = document.getElementById(`${uniqueId}-track`);
  const prevButton = document.getElementById(`${uniqueId}-prev`);
  const nextButton = document.getElementById(`${uniqueId}-next`);
  const dotsContainer = document.querySelector(`#${uniqueId} .mt-8`);
  let currentIndex = 0;
  let autoplayInterval;
  const slideDuration = 5000; // 5 seconds for autoplay

  if (!carouselTrack || !carouselTrackWrapper) {
    console.warn(`Testimonial carousel elements for #${uniqueId} not found. Carousel will not function.`);
  } else {
    const slides = Array.from(carouselTrack.children);
    if (slides.length <= 1) { // No need for carousel if 0 or 1 slide
      if (prevButton) prevButton.style.display = 'none';
      if (nextButton) nextButton.style.display = 'none';
      if (dotsContainer) dotsContainer.style.display = 'none';
      return; // Exit if no carousel needed
    }

    // Initial setup
    updateCarousel();
    startAutoplay();

    function updateCarousel() {
      const slideWidth = carouselTrackWrapper.offsetWidth; // Width of the visible wrapper
      const offset = -currentIndex * slideWidth;
      carouselTrack.style.transform = `translateX(${offset}px)`;

      // Update dots
      if (dotsContainer) {
        Array.from(dotsContainer.children).forEach((dot, index) => {
          const isCurrent = index === currentIndex;
          dot.classList.toggle('bg-primary', isCurrent);
          dot.classList.toggle('ring-2', isCurrent);
          dot.classList.toggle('ring-primary-light', isCurrent);
          dot.classList.toggle('bg-neutral-300', !isCurrent);
          dot.setAttribute('aria-selected', String(isCurrent));
          dot.setAttribute('tabindex', isCurrent ? '0' : '-1');
        });
      }

      // Update aria-hidden for screen readers on slides
      slides.forEach((slide, index) => {
        slide.setAttribute('aria-hidden', String(index !== currentIndex));
      });
    }

    function goToSlide(index) {
      currentIndex = (index + slides.length) % slides.length;
      updateCarousel();
      resetAutoplay();
    }

    function nextSlide() {
      goToSlide(currentIndex + 1);
    }

    function prevSlide() {
      goToSlide(currentIndex - 1);
    }

    if (prevButton) {
      prevButton.addEventListener('click', prevSlide);
    }
    if (nextButton) {
      nextButton.addEventListener('click', nextSlide);
    }

    if (dotsContainer) {
      dotsContainer.addEventListener('click', (event) => {
        const dot = event.target.closest('.dot');
        if (dot) {
          goToSlide(parseInt(dot.dataset.index));
        }
      });
    }

    function startAutoplay() {
      stopAutoplay(); // Clear any existing interval
      autoplayInterval = setInterval(nextSlide, slideDuration);
    }

    function stopAutoplay() {
      clearInterval(autoplayInterval);
    }

    function resetAutoplay() {
      stopAutoplay();
      startAutoplay();
    }

    // Pause autoplay on hover/focus for accessibility
    carouselTrackWrapper.addEventListener('mouseenter', stopAutoplay);
    carouselTrackWrapper.addEventListener('mouseleave', startAutoplay);
    if (prevButton) {
      prevButton.addEventListener('focus', stopAutoplay);
      prevButton.addEventListener('blur', startAutoplay);
    }
    if (nextButton) {
      nextButton.addEventListener('focus', stopAutoplay);
      nextButton.addEventListener('blur', startAutoplay);
    }
    if (dotsContainer) {
      dotsContainer.addEventListener('focusin', stopAutoplay);
      dotsContainer.addEventListener('focusout', startAutoplay);
    }

    // Keyboard navigation for carousel slides (left/right arrows)
    carouselTrack.addEventListener('keydown', (event) => {
      if (event.key === 'ArrowLeft') {
        prevSlide();
      } else if (event.key === 'ArrowRight') {
        nextSlide();
      }
    });

    // Re-calculate slide width on resize for accurate positioning
    window.addEventListener('resize', () => {
      // Small delay to allow CSS layout to update before recalculating
      setTimeout(updateCarousel, 100);
    });

    // Handle prefers-reduced-motion
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) {
      stopAutoplay();
      carouselTrack.style.transition = 'none';
      if (prevButton) prevButton.style.transition = 'none';
      if (nextButton) nextButton.style.transition = 'none';
      if (dotsContainer) dotsContainer.querySelectorAll('.dot').forEach(dot => dot.style.transition = 'none');
    }
  }
</script>

<style>
  .testimonial-carousel-section {
    background-color: var(--colors-background);
  }

  /* Carousel specific styles */
  #testimonial-carousel-track {
    /* This is the inner flex container that moves */
    transition: transform var(--animation-duration-normal) var(--animation-easing-default);
  }

  /* Accessibility focus states for navigation buttons */
  #testimonial-carousel-track:focus {
    @apply outline-none ring-2 ring-offset-2 ring-primary-light;
  }

  @media (prefers-reduced-motion: reduce) {
    #testimonial-carousel-track {
      transition: none !important;
    }
  }
</style>