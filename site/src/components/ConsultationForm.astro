---
import Input from './ui/Input.astro';
import Label from './ui/Label.astro';
import Button from './ui/Button.astro';

interface Props {
  formId: string;
  title?: string;
  description?: string;
}

const { formId, title = "Book Your Free Consultation", description = "Let's discuss your project and bring your vision to life. No pressure, just expert advice." } = Astro.props;

// Placeholder for Formspree endpoint. This should be an environment variable.
const FORMSPREE_ENDPOINT = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT || 'https://formspree.io/f/YOUR_FORMSPREE_ID';
---

<div class="bg-surface rounded-lg p-6 sm:p-8 shadow-md">
  <h3 class="font-heading text-2xl font-semibold text-text-dark mb-2">{title}</h3>
  <p class="text-text-muted mb-6">{description}</p>

  <form id={formId} action={FORMSPREE_ENDPOINT} method="POST" class="space-y-4">
    <Input id="full-name" name="name" type="text" label="Full Name" placeholder="John Doe" required autocomplete="name" />
    <Input id="email-address" name="email" type="email" label="Email Address" placeholder="john.doe@example.com" required autocomplete="email" />
    <Input id="phone-number" name="phone" type="tel" label="Phone Number" placeholder="(760) 555-1234" required autocomplete="tel" />

    <div>
      <Label for="project-type" text="Project Type" required />
      <select
        id="project-type"
        name="projectType"
        required
        class="w-full px-4 py-3 font-body text-base text-text-dark bg-surface
               border border-border rounded-md
               focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary
               disabled:bg-background disabled:cursor-not-allowed disabled:text-text-subtle"
      >
        <option value="">Select a service...</option>
        <option value="Painting Services">Painting Services</option>
        <option value="Handy Services">Handy Services</option>
        <option value="Both Painting & Handy Services">Both Painting & Handy Services</option>
      </select>
    </div>

    <Input id="service-location" name="location" type="text" label="Service Location (City/Zip)" placeholder="Carlsbad, CA 92008" required autocomplete="address-level2" />

    <div>
      <Label for="project-details" text="Project Details" required />
      <textarea
        id="project-details"
        name="projectDetails"
        rows={4}
        placeholder="Tell Joe about your project (e.g., 'Exterior house paint, 3 bedrooms, minor wood rot repair')."
        required
        class="w-full px-4 py-3 font-body text-base text-text-dark bg-surface
               border border-border rounded-md resize-y
               focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary
               placeholder-text-muted transition-all duration-150 ease-in-out
               disabled:bg-background disabled:cursor-not-allowed disabled:text-text-subtle"
      ></textarea>
    </div>

    <div>
      <Label text="Preferred Contact Method" required />
      <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-2">
        <label for="contact-phone" class="inline-flex items-center cursor-pointer">
          <input type="radio" id="contact-phone" name="preferredContact" value="Phone Call" class="form-radio text-primary focus:ring-primary" checked />
          <span class="ml-2 text-text-dark">Phone Call</span>
        </label>
        <label for="contact-email" class="inline-flex items-center cursor-pointer">
          <input type="radio" id="contact-email" name="preferredContact" value="Email" class="form-radio text-primary focus:ring-primary" />
          <span class="ml-2 text-text-dark">Email</span>
        </label>
      </div>
    </div>

    <Input id="how-heard" name="howHeard" type="text" label="How Did You Hear About Joe? (Optional)" placeholder="Google, Referral, Yelp, etc." autocomplete="off" />

    <!-- reCAPTCHA placeholder -->
    <div class="text-sm text-text-muted">
      This site is protected by reCAPTCHA and the Google
      <a href="https://policies.google.com/privacy" class="text-primary hover:underline" target="_blank" rel="noopener noreferrer">Privacy Policy</a> and
      <a href="https://policies.google.com/terms" class="text-primary hover:underline" target="_blank" rel="noopener noreferrer">Terms of Service</a> apply.
    </div>

    <Button type="submit" variant="primary" size="lg" class="w-full mt-6">
      Request My Free Consultation
    </Button>
  </form>
</div>

<script is:inline>
  const form = document.getElementById('{formId}');
  if (form) {
    form.addEventListener('submit', async function (event) {
      event.preventDefault(); // Prevent default form submission

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // Basic client-side validation for required fields (more robust validation should be done on server)
      let isValid = true;
      form.querySelectorAll('[required]').forEach(input => {
        if (!input.value.trim()) {
          input.classList.add('border-error');
          isValid = false;
        } else {
          input.classList.remove('border-error');
        }
      });

      if (!isValid) {
        alert('Please fill in all required fields.');
        return;
      }

      // Simulate reCAPTCHA token generation (actual reCAPTCHA v3 would integrate here)
      // For this task, we're just simulating success.
      data['g-recaptcha-response'] = 'mock-recaptcha-token';

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          // Redirect to thank you page
          window.location.href = '/thank-you'; // Ensure a /thank-you page exists or create one.
        } else {
          const errorData = await response.json();
          alert('Oops! Something went wrong submitting your form: ' + (errorData.message || 'Please try again.'));
        }
      } catch (error) {
        console.error('Submission error:', error);
        alert('Failed to connect to the server. Please try again later.');
      }
    });
  }
</script>