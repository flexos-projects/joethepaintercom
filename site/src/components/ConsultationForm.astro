---
/**
 * ConsultationForm.astro
 *
 * A reusable form component for users to request a free consultation.
 * Captures essential project details and contact preferences.
 * Includes placeholders for reCAPTCHA and submission handling.
 */

import type { HTMLAttributes } from 'astro/types';

interface Props extends HTMLAttributes<'form'> {
  /** Indicates if the form is currently submitting, disables the submit button. */
  loading?: boolean;
  /** Optional message to display if there's a general form error. */
  errorMessage?: string;
  /** Optional message to display on successful submission. */
  successMessage?: string;
}

const {
  loading = false,
  errorMessage,
  successMessage,
  class: className,
  ...attrs
} = Astro.props;

// Hardcoded service types for the dropdown
const serviceTypes = [
  { value: '', label: 'Select a service type' },
  { value: 'painting', label: 'Painting Services' },
  { value: 'handy', label: 'Handy Services' },
  { value: 'both', label: 'Both Painting & Handy Services' },
];

// Hardcoded preferred contact methods for radio buttons
const contactMethods = [
  { value: 'phone', label: 'Phone Call' },
  { value: 'email', label: 'Email' },
];

// Tailwind classes mapping to design tokens for form elements
const labelClasses = 'block text-sm font-medium text-text-dark mb-1';
const inputClasses =
  'w-full px-4 py-3 border border-border rounded-md text-base text-text-dark bg-surface placeholder:text-text-muted ' +
  'focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-150 ease-in-out';
const radioGroupClasses = 'flex flex-col sm:flex-row sm:gap-6 gap-2';
const radioInputClasses =
  'h-4 w-4 text-primary border-border focus:ring-primary focus:ring-2 transition-all duration-150 ease-in-out';
const radioLabelClasses = 'ml-2 text-base text-text-dark';
const buttonBaseClasses =
  'inline-flex items-center justify-center text-center text-lg font-semibold border border-primary rounded-md ' +
  'transition-all duration-150 ease-in-out px-6 py-4 w-full';
const buttonPrimaryClasses =
  'bg-primary text-white hover:bg-[#003B8D] active:bg-[#002A6B] active:translate-y-px ' +
  'hover:shadow-sm focus:ring-2 focus:ring-primary/50';
const buttonDisabledClasses = 'bg-text-subtle border-text-subtle text-surface cursor-not-allowed shadow-none';
---

<form
  method="POST"
  action="/api/submit-consultation" {/* Placeholder for backend endpoint */}
  class:list={['space-y-6', className]}
  {...attrs}
>
  {errorMessage && (
    <div role="alert" class="bg-error/10 border-l-4 border-error text-error p-4 rounded-md">
      <p class="font-medium">Error:</p>
      <p>{errorMessage}</p>
    </div>
  )}
  {successMessage && (
    <div role="alert" class="bg-success/10 border-l-4 border-success text-success p-4 rounded-md">
      <p class="font-medium">Success!</p>
      <p>{successMessage}</p>
    </div>
  )}

  {/* Full Name */}
  <div>
    <label for="fullName" class={labelClasses}>Full Name <span class="text-error">*</span></label>
    <input
      type="text"
      id="fullName"
      name="fullName"
      placeholder="John Doe"
      class={inputClasses}
      required
      aria-required="true"
    />
  </div>

  {/* Email Address */}
  <div>
    <label for="emailAddress" class={labelClasses}>Email Address <span class="text-error">*</span></label>
    <input
      type="email"
      id="emailAddress"
      name="emailAddress"
      placeholder="john.doe@example.com"
      class={inputClasses}
      required
      aria-required="true"
    />
  </div>

  {/* Phone Number */}
  <div>
    <label for="phoneNumber" class={labelClasses}>Phone Number <span class="text-error">*</span></label>
    <input
      type="tel"
      id="phoneNumber"
      name="phoneNumber"
      placeholder="(760) 555-1234"
      class={inputClasses}
      required
      aria-required="true"
    />
  </div>

  {/* Service Type (Dropdown) */}
  <div>
    <label for="serviceType" class={labelClasses}>Project Type <span class="text-error">*</span></label>
    <div class="relative">
      <select
        id="serviceType"
        name="serviceType"
        class={inputClasses + ' appearance-none pr-10'}
        required
        aria-required="true"
      >
        {serviceTypes.map((type) => (
          <option value={type.value} disabled={type.value === ''} selected={type.value === ''}>
            {type.label}
          </option>
        ))}
      </select>
      <svg
        class="pointer-events-none absolute inset-y-0 right-3 flex items-center h-full w-5 text-text-muted"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 20 20"
        fill="currentColor"
        aria-hidden="true"
      >
        <path
          fill-rule="evenodd"
          d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
          clip-rule="evenodd"
        />
      </svg>
    </div>
  </div>

  {/* Project Description (Textarea) */}
  <div>
    <label for="projectDescription" class={labelClasses}>Project Details <span class="text-error">*</span></label>
    <textarea
      id="projectDescription"
      name="projectDescription"
      rows={5}
      placeholder="Tell Joe about your project (e.g., 'Exterior house paint, 3 bedrooms, needs some drywall repair')."
      class={inputClasses}
      required
      aria-required="true"
    ></textarea>
  </div>

  {/* Preferred Contact Method (Radio) */}
  <fieldset>
    <legend class={labelClasses + ' mb-2'}>Preferred Contact Method <span class="text-error">*</span></legend>
    <div role="radiogroup" aria-required="true" class={radioGroupClasses}>
      {contactMethods.map((method) => (
        <div class="flex items-center">
          <input
            type="radio"
            id={`contact-${method.value}`}
            name="preferredContact"
            value={method.value}
            class={radioInputClasses}
            required
          />
          <label for={`contact-${method.value}`} class={radioLabelClasses}>
            {method.label}
          </label>
        </div>
      ))}
    </div>
  </fieldset>

  {/* reCAPTCHA Placeholder */}
  <div class="text-sm text-text-muted">
    This site is protected by reCAPTCHA and the Google
    <a href="https://policies.google.com/privacy" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">Privacy Policy</a> and
    <a href="https://policies.google.com/terms" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">Terms of Service</a> apply.
    {/* Actual reCAPTCHA widget will be integrated here in a later task */}
    <div class="mt-2" aria-label="reCAPTCHA verification area">
      {/* Placeholder for reCAPTCHA widget */}
    </div>
  </div>

  {/* Submit Button */}
  <button
    type="submit"
    class:list={[buttonBaseClasses, buttonPrimaryClasses, { [buttonDisabledClasses]: loading }]}
    disabled={loading}
    aria-label={loading ? 'Submitting request' : 'Request My Free Consultation'}
  >
    {loading ? (
      <span class="flex items-center gap-2">
        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending Request...
      </span>
    ) : (
      'Request My Free Consultation'
    )}
  </button>
</form>
---