---
/**
 * ConsultationForm
 * A comprehensive form for users to request a free consultation.
 */

import Input from './ui/Input.astro';
import Select from './ui/Select.astro';
import Textarea from './ui/Textarea.astro';
import RadioGroup from './ui/RadioGroup.astro';
import Button from './ui/Button.astro';

interface Props {
  /** Optional title for the form */
  title?: string;
  /** Optional description for the form */
  description?: string;
  /** Optional redirect URL after successful submission */
  successRedirectUrl?: string;
  /** Endpoint for form submission (e.g., Formspree). Must be provided via environment variable. */
  formAction?: string;
}

const {
  title = 'Book Your Free Consultation',
  description = 'Let\'s discuss your project. Joe personally reviews every request and will be in touch within 1 business day.',
  successRedirectUrl = '/thank-you',
  formAction = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT_URL,
} = Astro.props;

// Validate formAction is provided, as it's critical and no generic placeholder is allowed.
if (!formAction) {
  throw new Error('ConsultationForm: formAction is required. Ensure PUBLIC_FORMSPREE_ENDPOINT_URL environment variable is set in .env file.');
}

const serviceTypeOptions = [
  { value: 'painting', label: 'Painting Services' },
  { value: 'handy', label: 'Handy Services' },
  { value: 'both', label: 'Both Painting & Handy Services' },
];

const preferredContactOptions = [
  { value: 'phone', label: 'Phone Call' },
  { value: 'email', label: 'Email' },
];
---

<div class="bg-surface rounded-lg p-6 md:p-8 shadow-md">
  <h2 class="font-heading text-2xl md:text-3xl font-bold text-text mb-2">
    {title}
  </h2>
  <p class="font-body text-base text-textMuted mb-6">
    {description}
  </p>

  <form
    method="POST"
    action={formAction}
    class="space-y-4"
    onsubmit="return false;"
    data-consultation-form
    data-success-redirect-url={successRedirectUrl}
  >
    <Input
      label="Full Name"
      id="fullName"
      type="text"
      placeholder="John Doe"
      name="fullName"
      required
    />
    <p id="fullName-error" class="text-error text-sm mt-1"></p>

    <Input
      label="Email Address"
      id="email"
      type="email"
      placeholder="john.doe@example.com"
      name="email"
      required
    />
    <p id="email-error" class="text-error text-sm mt-1"></p>

    <Input
      label="Phone Number"
      id="phoneNumber"
      type="tel"
      placeholder="(760) 555-1234"
      name="phoneNumber"
      required
    />
    <p id="phoneNumber-error" class="text-error text-sm mt-1"></p>

    <Select
      label="Project Type"
      id="projectType"
      options={serviceTypeOptions}
      placeholder="Select a service type"
      name="projectType"
      required
    />
    <p id="projectType-error" class="text-error text-sm mt-1"></p>

    <Input
      label="Service Location (City or Zip Code)"
      id="serviceLocation"
      type="text"
      placeholder="Carlsbad, CA or 92008"
      name="serviceLocation"
      required
    />
    <p id="serviceLocation-error" class="text-error text-sm mt-1"></p>

    <Textarea
      label="Project Details"
      id="projectDetails"
      placeholder="e.g., Exterior house paint, 3 bedrooms, drywall repair needed."
      rows={4}
      name="projectDetails"
      required
    />
    <p id="projectDetails-error" class="text-error text-sm mt-1"></p>

    <RadioGroup
      label="Preferred Contact Method"
      name="preferredContact"
      options={preferredContactOptions}
      required
    />
    <p id="preferredContact-error" class="text-error text-sm mt-1"></p>

    <Input
      label="How Did You Hear About Joe? (Optional)"
      id="howDidYouHear"
      type="text"
      placeholder="e.g., Google, Friend's referral, Yelp"
      name="howDidYouHear"
      required={false}
    />
    <p id="howDidYouHear-error" class="text-error text-sm mt-1"></p>

    <div class="pt-2">
      <Button type="submit" fullWidth size="lg">
        Request My Free Consultation
      </Button>
    </div>
  </form>
</div>

<script is:inline>
  // This script provides client-side form submission logic for Astro's SSG.
  // It handles basic validation and displays error messages dynamically.
  const formElement = document.querySelector('[data-consultation-form]');
  if (formElement) {
    formElement.addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      // Clear previous errors
      form.querySelectorAll('.border-error').forEach(el => el.classList.remove('border-error'));
      form.querySelectorAll('[id$="-error"]').forEach(el => el.textContent = '');
      form.querySelectorAll('.radio-group.border-error').forEach(el => el.classList.remove('border-error'));

      // Simple client-side validation
      let hasError = false;
      const fields = [
        { id: 'fullName', label: 'Full Name', validation: (val) => val && val.length >= 2, error: 'Full Name is required and must be at least 2 characters.' },
        { id: 'email', label: 'Email Address', validation: (val) => val && /\S+@\S+\.\S+/.test(val), error: 'A valid Email Address is required.' },
        { id: 'phoneNumber', label: 'Phone Number', validation: (val) => val && /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(val), error: 'A valid Phone Number is required.' },
        { id: 'projectType', label: 'Project Type', validation: (val) => !!val, error: 'Please select a Project Type.' },
        { id: 'serviceLocation', label: 'Service Location', validation: (val) => val && val.length >= 3, error: 'Service Location is required and must be at least 3 characters.' },
        { id: 'projectDetails', label: 'Project Details', validation: (val) => val && val.length >= 10, error: 'Please provide Project Details (min 10 characters).' },
        { id: 'preferredContact', label: 'Preferred Contact Method', validation: (val) => !!val, error: 'Please select a Preferred Contact method.' },
      ];

      fields.forEach(field => {
        const value = formData.get(field.id) as string;
        const inputElement = form.querySelector(`[name="${field.id}"]`) || form.querySelector(`[id="${field.id}"]`);
        const errorMessageElement = form.querySelector(`#${field.id}-error`);

        // Special handling for RadioGroup to check if any option is selected
        if (field.id === 'preferredContact') {
          const radioGroupInputs = form.querySelectorAll(`input[name="${field.id}"]`);
          const isRadioSelected = Array.from(radioGroupInputs).some((radio: HTMLInputElement) => radio.checked);
          if (!isRadioSelected) {
            const radioGroupContainer = form.querySelector(`[name="${field.id}"]`)?.closest('div'); // Assuming RadioGroup has a div wrapper
            if (radioGroupContainer) radioGroupContainer.classList.add('border-error');
            if (errorMessageElement) errorMessageElement.textContent = field.error;
            hasError = true;
          }
        } else if (inputElement && !field.validation(value)) {
          inputElement.classList.add('border-error');
          if (errorMessageElement) errorMessageElement.textContent = field.error;
          hasError = true;
        }
      });

      if (hasError) {
        const firstErrorElement = form.querySelector('.border-error');
        if (firstErrorElement) {
          (firstErrorElement as HTMLElement).focus(); // Focus on the first element with an error
        }
        return;
      }

      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = `<span class="inline-flex items-center"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Sending Request...</span>`;

      try {
        const formAction = form.getAttribute('action');
        const response = await fetch(formAction, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
          },
          body: formData,
        });

        if (response.ok) {
          const successRedirectUrl = formElement.dataset.successRedirectUrl || '/thank-you';
          window.location.href = successRedirectUrl;
        } else {
          const errorData = await response.json();
          console.error('Form submission failed:', errorData);
          alert('Oops! Something went wrong. Please try again or call Joe directly at (760) 580-8173.');
        }
      } catch (error) {
        console.error('Network error:', error);
        alert('A network error occurred. Please check your connection or call Joe directly at (760) 580-8173.');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
      }
    });
  }
</script>