---
/**
 * ConsultationForm.astro
 *
 * A reusable component for capturing client inquiries and consultation requests.
 * Features various input types, a service selection dropdown, preferred contact
 * method radio buttons, and a reCAPTCHA disclosure as required by specs.
 * Ensures accessibility and adheres to the brand's design system.
 */

// Type imports
import type { HTMLAttributes } from 'astro/types';

// Props interface with JSDoc comments
interface Props extends HTMLAttributes<'form'> {
  // Allows standard HTML form attributes to be passed through.
}

// Destructure props, allowing for class pass-through
const { class: className, ...attrs } = Astro.props;

// Formspree endpoint from environment variable, with a fallback for local dev/testing
const FORMSPREE_ENDPOINT = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT_URL || 'https://formspree.io/f/joethepaintercom-kibm3';
---

<form
  class:list={[
    'consultation-form',
    'space-y-6', // Spacing between form groups
    'bg-surface',
    'p-6',
    'lg:p-8', // Slightly more padding on larger screens
    'rounded-lg',
    'shadow-md',
    className,
  ]}
  aria-labelledby="form-title"
  method="POST"
  action={FORMSPREE_ENDPOINT}
  {...attrs}
>
  <h2 id="form-title" class="font-heading text-3xl font-semibold text-text mb-4">
    Book Your Free Consultation
  </h2>
  <p class="text-lg text-textMuted mb-6">
    Tell Joe about your project. He'll get back to you within 1 business day.
  </p>

  <!-- Full Name Field -->
  <div>
    <label for="fullName" class="block text-sm font-medium text-text mb-1">Full Name</label>
    <input
      type="text"
      id="fullName"
      name="fullName"
      placeholder="John Doe"
      required
      autocomplete="name"
      class="block w-full border border-border rounded-md p-3 text-base text-text bg-surface placeholder-textMuted
             focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary
             transition-all duration-150 ease-in-out
             motion-reduce:transition-none"
    />
  </div>

  <!-- Email Address Field -->
  <div>
    <label for="email" class="block text-sm font-medium text-text mb-1">Email Address</label>
    <input
      type="email"
      id="email"
      name="email"
      placeholder="john.doe@example.com"
      required
      autocomplete="email"
      class="block w-full border border-border rounded-md p-3 text-base text-text bg-surface placeholder-textMuted
             focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary
             transition-all duration-150 ease-in-out
             motion-reduce:transition-none"
    />
  </div>

  <!-- Phone Number Field -->
  <div>
    <label for="phone" class="block text-sm font-medium text-text mb-1">Phone Number</label>
    <input
      type="tel"
      id="phone"
      name="phone"
      placeholder="(760) 555-1234"
      required
      autocomplete="tel"
      class="block w-full border border-border rounded-md p-3 text-base text-text bg-surface placeholder-textMuted
             focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary
             transition-all duration-150 ease-in-out
             motion-reduce:transition-none"
    />
  </div>

  <!-- Service Location Field -->
  <div>
    <label for="serviceLocation" class="block text-sm font-medium text-text mb-1">Service Location</label>
    <input
      type="text"
      id="serviceLocation"
      name="serviceLocation"
      placeholder="e.g., Carlsbad, Encinitas, 92009"
      required
      autocomplete="address-level2"
      class="block w-full border border-border rounded-md p-3 text-base text-text bg-surface placeholder-textMuted
             focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary
             transition-all duration-150 ease-in-out
             motion-reduce:transition-none"
    />
  </div>

  <!-- Service Type Dropdown -->
  <div>
    <label for="serviceType" class="block text-sm font-medium text-text mb-1">Service Type</label>
    <div class="relative">
      <select
        id="serviceType"
        name="serviceType"
        required
        class="block w-full appearance-none border border-border rounded-md p-3 text-base text-text bg-surface
               focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary
               transition-all duration-150 ease-in-out
               motion-reduce:transition-none pr-10"
      >
        <option value="" disabled selected>Select a service type...</option>
        <option value="Painting">Painting Services</option>
        <option value="Handy">Handy Services</option>
        <option value="Both">Both Painting & Handy Services</option>
      </select>
      <!-- Custom dropdown arrow for better styling control -->
      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-textMuted">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>
  </div>

  <!-- Project Description Textarea -->
  <div>
    <label for="projectDescription" class="block text-sm font-medium text-text mb-1">Project Details</label>
    <textarea
      id="projectDescription"
      name="projectDescription"
      rows="4"
      placeholder="Briefly describe your project (e.g., 'Exterior house paint, 3 bedrooms, stucco repair needed')."
      required
      class="block w-full border border-border rounded-md p-3 text-base text-text bg-surface placeholder-textMuted
             focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary
             transition-all duration-150 ease-in-out
             motion-reduce:transition-none resize-y"
    ></textarea>
  </div>

  <!-- Preferred Contact Method Radio Buttons -->
  <fieldset class="space-y-2">
    <legend class="block text-sm font-medium text-text mb-1">Preferred Contact Method</legend>
    <div class="flex items-center gap-4">
      <input
        type="radio"
        id="contactPhone"
        name="preferredContact"
        value="Phone"
        required
        class="h-4 w-4 text-primary border-border focus:ring-primary
               transition-all duration-150 ease-in-out
               motion-reduce:transition-none cursor-pointer"
      />
      <label for="contactPhone" class="text-base text-textMuted cursor-pointer">Phone Call</label>
    </div>
    <div class="flex items-center gap-4">
      <input
        type="radio"
        id="contactEmail"
        name="preferredContact"
        value="Email"
        required
        class="h-4 w-4 text-primary border-border focus:ring-primary
               transition-all duration-150 ease-in-out
               motion-reduce:transition-none cursor-pointer"
      />
      <label for="contactEmail" class="text-base text-textMuted cursor-pointer">Email</label>
    </div>
  </fieldset>

  <!-- How Did You Hear About Joe? (Optional) -->
  <div>
    <label for="howHear" class="block text-sm font-medium text-text mb-1">How Did You Hear About Joe?</label>
    <input
      type="text"
      id="howHear"
      name="howHear"
      placeholder="e.g., Google, Friend's referral, Yelp"
      autocomplete="off"
      class="block w-full border border-border rounded-md p-3 text-base text-text bg-surface placeholder-textMuted
             focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary
             transition-all duration-150 ease-in-out
             motion-reduce:transition-none"
    />
  </div>

  <!-- reCAPTCHA Disclosure -->
  <div class="recaptcha-disclosure text-sm text-textMuted">
    <p>This site is protected by reCAPTCHA and the Google <a href="https://policies.google.com/privacy" class="text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary transition-all duration-150 ease-in-out motion-reduce:transition-none" target="_blank" rel="noopener noreferrer">Privacy Policy</a> and <a href="https://policies.google.com/terms" class="text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary/[.2] focus:border-primary transition-all duration-150 ease-in-out motion-reduce:transition-none" target="_blank" rel="noopener noreferrer">Terms of Service</a> apply.</p>
  </div>

  <!-- Submit Button -->
  <button
    type="submit"
    class="w-full text-center px-4 py-3 text-base font-semibold rounded-md
           bg-primary text-surface border border-primary
           hover:bg-[#003B8D] hover:border-[#003B8D] hover:shadow-sm
           active:bg-[#002A6B] active:border-[#002A6B] active:translate-y-px
           focus:outline-none focus:ring-4 focus:ring-primary/[.2]
           transition-all duration-150 ease-in-out
           motion-reduce:transition-none"
  >
    Request My Free Consultation
  </button>
</form>

<script is:inline>
  const form = document.querySelector('.consultation-form');
  const submitButton = form?.querySelector('button[type="submit"]');
  const originalButtonText = submitButton?.textContent;

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();

    if (!submitButton || !originalButtonText) return;

    // Basic client-side validation
    const requiredInputs = form.querySelectorAll('[required]');
    let allValid = true;
    requiredInputs.forEach(input => {
      if (!input.checkValidity()) {
        allValid = false;
        input.classList.add('border-error'); // Add error styling
      } else {
        input.classList.remove('border-error');
      }
    });

    if (!allValid) {
      form.querySelector(':invalid')?.focus();
      return;
    }

    submitButton.disabled = true;
    submitButton.innerHTML = `
      <span class="flex items-center justify-center gap-2">
        <svg class="animate-spin h-5 w-5 text-surface" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Sending Request...
      </span>
    `;

    const formData = new FormData(form);
    const formspreeEndpoint = form.action; // Get action from form attribute

    try {
      const response = await fetch(formspreeEndpoint, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        // As per 05-flows.md, redirect to /thank-you page
        window.location.href = '/thank-you';
      } else {
        const data = await response.json();
        const errorMessage = data.errors ? data.errors.map(e => e.message).join(', ') : 'Form submission failed. Please try again.';
        alert(errorMessage);
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
      }
    } catch (error) {
      console.error('Network error:', error);
      alert('A network error occurred. Please try again later.');
      submitButton.disabled = false;
      submitButton.textContent = originalButtonText;
    }
  });
</script>