---
import Button from '@/components/ui/Button.astro';
import Input from '@/components/ui/Input.astro';
import Label from '@/components/ui/Label.astro';
import Select from '@/components/ui/Select.astro';
import Textarea from '@/components/ui/Textarea.astro';

interface Props {
  ctaText?: string;
  formId: string; // Unique ID for the form, for reCAPTCHA and identification
}

const { ctaText = 'Request My Free Consultation', formId } = Astro.props;

const RECAPTCHA_SITE_KEY = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;
---

<form id={formId} class="space-y-6 bg-white p-8 shadow-lg rounded-lg" data-form-type="consultation">
  <h2 class="text-3xl font-heading font-bold text-neutral-800 mb-6">Book Your Free Consultation</h2>
  <p class="text-neutral-600 mb-8">
    Tell Joe about your project! He'll get back to you within 1 business day to discuss your needs and provide a no-obligation estimate.
  </p>

  <div>
    <Label for={`${formId}-fullName`}>Full Name</Label>
    <Input
      type="text"
      id={`${formId}-fullName`}
      name="fullName"
      placeholder="John Doe"
      required
      aria-required="true"
      minlength="2"
      pattern="[A-Za-z\s]+"
      title="Name should only contain letters and spaces"
    />
    <p id={`${formId}-fullName-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please enter your full name.</p>
  </div>

  <div>
    <Label for={`${formId}-email`}>Email Address</Label>
    <Input
      type="email"
      id={`${formId}-email`}
      name="email"
      placeholder="john.doe@example.com"
      required
      aria-required="true"
    />
    <p id={`${formId}-email-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please enter a valid email address.</p>
  </div>

  <div>
    <Label for={`${formId}-phone`}>Phone Number</Label>
    <Input
      type="tel"
      id={`${formId}-phone`}
      name="phone"
      placeholder="(760) 555-1234"
      required
      aria-required="true"
      pattern="^(\+\d{1,2}\s?)?1?\-?\.?\s?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$"
      title="Please enter a valid US phone number"
    />
    <p id={`${formId}-phone-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please enter a valid phone number.</p>
  </div>

  <div>
    <Label for={`${formId}-projectType`}>Project Type</Label>
    <Select id={`${formId}-projectType`} name="projectType" required aria-required="true">
      <option value="">Select a service type</option>
      <option value="Painting Services">Painting Services</option>
      <option value="Handy Services">Handy Services</option>
      <option value="Both Painting & Handy Services">Both Painting & Handy Services</option>
    </Select>
    <p id={`${formId}-projectType-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please select a project type.</p>
  </div>

  <div>
    <Label for={`${formId}-serviceLocation`}>Service Location (City or Zip Code)</Label>
    <Input
      type="text"
      id={`${formId}-serviceLocation`}
      name="serviceLocation"
      placeholder="Carlsbad, CA or 92008"
      required
      aria-required="true"
      minlength="3"
    />
    <p id={`${formId}-serviceLocation-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please enter your service location.</p>
  </div>

  <div>
    <Label for={`${formId}-projectDetails`}>Project Details</Label>
    <Textarea
      id={`${formId}-projectDetails`}
      name="projectDetails"
      rows="4"
      placeholder="Describe your project (e.g., 'Exterior house paint for a 3-bedroom home, minor stucco repair needed')"
      required
      aria-required="true"
      minlength="10"
      maxlength="500"
    ></Textarea>
    <p id={`${formId}-projectDetails-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please provide details about your project (min 10 characters, max 500).</p>
  </div>

  <div>
    <Label>Preferred Contact Method</Label>
    <div class="mt-2 space-y-2">
      <div class="flex items-center">
        <input type="radio" id={`${formId}-contactPhone`} name="preferredContact" value="Phone Call" class="form-radio h-4 w-4 text-primary focus:ring-primary border-neutral-300" required aria-required="true">
        <Label for={`${formId}-contactPhone`} class="ml-2 mb-0">Phone Call</Label>
      </div>
      <div class="flex items-center">
        <input type="radio" id={`${formId}-contactEmail`} name="preferredContact" value="Email" class="form-radio h-4 w-4 text-primary focus:ring-primary border-neutral-300" required aria-required="true">
        <Label for={`${formId}-contactEmail`} class="ml-2 mb-0">Email</Label>
      </div>
    </div>
    <p id={`${formId}-preferredContact-error`} class="text-error text-sm mt-1 hidden" aria-live="polite">Please select a preferred contact method.</p>
  </div>

  <div>
    <Label for={`${formId}-howDidYouHear`}>How Did You Hear About Joe? (Optional)</Label>
    <Input
      type="text"
      id={`${formId}-howDidYouHear`}
      name="howDidYouHear"
      placeholder="e.g., Google, friend's referral, Yelp"
      maxlength="100"
    />
  </div>

  <input type="hidden" name="g-recaptcha-response" id={`${formId}-recaptcha-response`} />

  <div id={`${formId}-status-message`} class="mt-4 p-3 rounded-md hidden" role="status"></div>

  <Button type="submit" size="lg" class="w-full" id={`${formId}-submit-btn`}>
    {ctaText}
  </Button>
</form>

<script is:inline define:RECAPTCHA_SITE_KEY={RECAPTCHA_SITE_KEY}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('{formId}');
    const statusMessage = document.getElementById('{formId}-status-message');
    const submitButton = document.getElementById('{formId}-submit-btn');

    const showMessage = (message, type = 'info') => {
      statusMessage.textContent = message;
      statusMessage.classList.remove('hidden', 'bg-error', 'bg-success', 'bg-warning', 'bg-info');
      statusMessage.classList.add(`bg-${type}`, 'text-neutral-800');
      statusMessage.style.display = 'block'; // Ensure it's visible
    };

    const hideMessage = () => {
      statusMessage.classList.add('hidden');
      statusMessage.style.display = 'none';
    };

    const validateField = (inputElement, errorElement, minLength, maxLength, pattern) => {
      if (!inputElement) return true; // Skip if element not found

      let isValid = true;
      let errorMessage = '';

      if (inputElement.required && !inputElement.value.trim()) {
        isValid = false;
        errorMessage = 'This field is required.';
      } else if (minLength && inputElement.value.trim().length < minLength) {
        isValid = false;
        errorMessage = `Minimum length is ${minLength} characters.`;
      } else if (maxLength && inputElement.value.trim().length > maxLength) {
        isValid = false;
        errorMessage = `Maximum length is ${maxLength} characters.`;
      } else if (pattern && !new RegExp(pattern).test(inputElement.value.trim())) {
        isValid = false;
        errorMessage = inputElement.title || 'Invalid format.';
      } else if (inputElement.type === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inputElement.value.trim())) {
        isValid = false;
        errorMessage = 'Please enter a valid email address.';
      } else if (inputElement.type === 'tel' && !/^(\+\d{1,2}\s?)?1?\-?\.?\s?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/.test(inputElement.value.trim())) {
        isValid = false;
        errorMessage = 'Please enter a valid US phone number.';
      }

      if (inputElement.type === 'radio' && inputElement.name === 'preferredContact') {
        const checked = form.querySelector(`input[name="preferredContact"]:checked`);
        if (!checked) {
          isValid = false;
          errorMessage = 'Please select a preferred contact method.';
        }
      }

      if (inputElement.tagName === 'SELECT' && inputElement.required && !inputElement.value) {
        isValid = false;
        errorMessage = 'Please select an option.';
      }

      if (!isValid) {
        inputElement.classList.add('border-error');
        errorElement.textContent = errorMessage;
        errorElement.classList.remove('hidden');
      } else {
        inputElement.classList.remove('border-error');
        errorElement.classList.add('hidden');
      }
      return isValid;
    };

    const validateForm = () => {
      hideMessage();
      let isFormValid = true;

      isFormValid = validateField(form.elements[`${formId}-fullName`], document.getElementById(`${formId}-fullName-error`), 2, null, '[A-Za-z\\s]+') && isFormValid;
      isFormValid = validateField(form.elements[`${formId}-email`], document.getElementById(`${formId}-email-error`)) && isFormValid;
      isFormValid = validateField(form.elements[`${formId}-phone`], document.getElementById(`${formId}-phone-error`)) && isFormValid;
      isFormValid = validateField(form.elements[`${formId}-projectType`], document.getElementById(`${formId}-projectType-error`)) && isFormValid;
      isFormValid = validateField(form.elements[`${formId}-serviceLocation`], document.getElementById(`${formId}-serviceLocation-error`), 3) && isFormValid;
      isFormValid = validateField(form.elements[`${formId}-projectDetails`], document.getElementById(`${formId}-projectDetails-error`), 10, 500) && isFormValid;
      isFormValid = validateField(form.elements.preferredContact, document.getElementById(`${formId}-preferredContact-error`)) && isFormValid; // For radio buttons

      return isFormValid;
    };

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!validateForm()) {
        showMessage('Please correct the errors in the form.', 'error');
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = 'Sending Request...';
      submitButton.classList.add('opacity-75', 'cursor-not-allowed');
      hideMessage();

      try {
        if (typeof grecaptcha !== 'undefined' && RECAPTCHA_SITE_KEY) {
          const token = await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'submit_form' });
          document.getElementById('{formId}-recaptcha-response').value = token;
        } else {
          console.warn('reCAPTCHA not loaded or site key missing. Submitting without reCAPTCHA token.');
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.formType = form.dataset.formType; // Add form type for backend differentiation

        const response = await fetch('/api/submit-form', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok) {
          showMessage('Thank You! Your Free Consultation Request Has Been Received. Joe will be in touch within 1 business day.', 'success');
          form.reset(); // Clear form fields on success
          window.location.href = '/thank-you'; // Redirect to a thank you page as per flow
        } else {
          showMessage(result.message || 'Oops! Something went wrong on our end. Please try again or call Joe directly at (760) 580-8173.', 'error');
        }
      } catch (error) {
        console.error('Form submission error:', error);
        showMessage('An unexpected error occurred. Please try again or call Joe directly at (760) 580-8173.', 'error');
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = '{ctaText}';
        submitButton.classList.remove('opacity-75', 'cursor-not-allowed');
      }
    });

    // Add real-time validation feedback on blur
    form.elements[`${formId}-fullName`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-fullName-error`), 2, null, '[A-Za-z\\s]+'));
    form.elements[`${formId}-email`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-email-error`)));
    form.elements[`${formId}-phone`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-phone-error`)));
    form.elements[`${formId}-projectType`]?.addEventListener('change', (e) => validateField(e.target, document.getElementById(`${formId}-projectType-error`)));
    form.elements[`${formId}-serviceLocation`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-serviceLocation-error`), 3));
    form.elements[`${formId}-projectDetails`]?.addEventListener('blur', (e) => validateField(e.target, document.getElementById(`${formId}-projectDetails-error`), 10, 500));
    // Handle radio buttons blur/change events
    form.querySelectorAll(`input[name="preferredContact"]`).forEach(radio => radio.addEventListener('change', () => validateField(form.elements.preferredContact, document.getElementById(`${formId}-preferredContact-error`))));
  });
</script>