---
import Label from './ui/Label.astro';
import Input from './ui/Input.astro';
import Textarea from './ui/Textarea.astro';
import Button from './ui/Button.astro';

interface Props {
  id?: string;
  formspreeEndpoint?: string; // Optional override, otherwise uses env var
  onSuccess?: string; // URL to redirect on success
}

const { id = 'consultation-form', formspreeEndpoint, onSuccess = '/thank-you' } = Astro.props;

// Use environment variable for Formspree endpoint, or provide a default if not set for dev
const endpoint = formspreeEndpoint || import.meta.env.FORMSPREE_ENDPOINT_URL || 'https://formspree.io/f/yourformid';
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;
---

<form id={id} method="POST" action={endpoint} class="space-y-spacing-4 bg-surface p-spacing-6 rounded-lg shadow-md">
  <input type="hidden" name="g-recaptcha-response" id={`${id}-recaptcha-response`} />

  <div>
    <Label for={`${id}-name`} required>Full Name</Label>
    <Input id={`${id}-name`} name="name" type="text" placeholder="John Doe" required autocomplete="name" />
  </div>

  <div>
    <Label for={`${id}-email`} required>Email Address</Label>
    <Input id={`${id}-email`} name="email" type="email" placeholder="john.doe@example.com" required autocomplete="email" />
  </div>

  <div>
    <Label for={`${id}-phone`} required>Phone Number</Label>
    <Input id={`${id}-phone`} name="phone" type="tel" placeholder="(760) 555-1234" required autocomplete="tel" />
  </div>

  <div>
    <Label for={`${id}-project-type`} required>Project Type</Label>
    <div class="relative">
      <select
        id={`${id}-project-type`}
        name="projectType"
        required
        class="block appearance-none w-full px-spacing-3 py-spacing-2 border rounded-md text-text bg-surface border-border focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-normal pr-spacing-8"
      >
        <option value="">Select a service type</option>
        <option value="Painting Services">Painting Services</option>
        <option value="Handy Services">Handy Services</option>
        <option value="Both Painting & Handy Services">Both Painting & Handy Services</option>
      </select>
      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-spacing-2 text-text-muted">
        <svg class="fill-current h-spacing-4 w-spacing-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
      </div>
    </div>
  </div>

  <div>
    <Label for={`${id}-location`} required>Service Location</Label>
    <Input id={`${id}-location`} name="location" type="text" placeholder="Carlsbad, CA or 92008" required />
  </div>

  <div>
    <Label for={`${id}-description`} required>Project Details</Label>
    <Textarea id={`${id}-description`} name="projectDetails" rows={5} placeholder="Tell Joe about your project (e.g., 'Exterior house paint, 3 bedrooms')" required />
  </div>

  <div>
    <Label>Preferred Contact Method</Label>
    <div class="flex flex-col space-y-spacing-2 mt-spacing-2">
      <div class="flex items-center">
        <input type="radio" id={`${id}-contact-phone`} name="preferredContact" value="Phone Call" class="h-spacing-4 w-spacing-4 text-primary border-border focus:ring-primary" required />
        <label for={`${id}-contact-phone`} class="ml-spacing-2 text-text-muted">Phone Call</label>
      </div>
      <div class="flex items-center">
        <input type="radio" id={`${id}-contact-email`} name="preferredContact" value="Email" class="h-spacing-4 w-spacing-4 text-primary border-border focus:ring-primary" />
        <label for={`${id}-contact-email`} class="ml-spacing-2 text-text-muted">Email</label>
      </div>
    </div>
  </div>

  <div>
    <Label for={`${id}-how-heard`}>How Did You Hear About Joe? (Optional)</Label>
    <Input id={`${id}-how-heard`} name="howHeard" type="text" placeholder="e.g., Google, Friend's referral, Yelp" />
  </div>

  <Button type="submit" variant="primary" size="lg" class="w-full">
    Request My Free Consultation
  </Button>
</form>

<script is:inline define:vars={{ formId: id, recaptchaSiteKey: recaptchaSiteKey, onSuccessUrl: onSuccess }}>
  const form = document.getElementById(formId);
  const recaptchaResponseInput = document.getElementById(`${formId}-recaptcha-response`);

  if (form && recaptchaResponseInput && recaptchaSiteKey) {
    form.addEventListener('submit', function (event) {
      event.preventDefault(); // Prevent default form submission

      if (typeof grecaptcha !== 'undefined' && grecaptcha.ready) {
        grecaptcha.ready(function() {
          grecaptcha.execute(recaptchaSiteKey, { action: 'submit_form' }).then(function(token) {
            recaptchaResponseInput.value = token;
            form.submit(); // Submit the form after getting the token
          }).catch(function(error) {
            console.error('reCAPTCHA execution failed:', error);
            // Fallback: submit form without recaptcha token if it fails
            form.submit();
          });
        });
      } else {
        console.warn('reCAPTCHA script not fully loaded or ready. Submitting form without token.');
        form.submit(); // Fallback: submit form without recaptcha token
      }
    });
  } else {
    // This warning should only appear if PUBLIC_RECAPTCHA_SITE_KEY is not set (e.g., in development)
    // or if the DOM elements are missing.
    console.warn('reCAPTCHA integration skipped: form, recaptcha input, or site key missing. Ensure PUBLIC_RECAPTCHA_SITE_KEY is set in your .env file for production.');
  }
</script>