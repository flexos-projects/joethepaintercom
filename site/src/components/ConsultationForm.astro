---
/**
 * ConsultationForm
 * A comprehensive form for users to request a free consultation.
 */

import Input from './ui/Input.astro';
import Select from './ui/Select.astro';
import Textarea from './ui/Textarea.astro';
import RadioGroup from './ui/RadioGroup.astro';
import Button from './ui/Button.astro';
import Icon from './ui/Icon.astro';

interface Props {
  /** Optional title for the form */
  title?: string;
  /** Optional description for the form */
  description?: string;
  /** Optional redirect URL after successful submission */
  successRedirectUrl?: string;
  /** Optional endpoint for form submission (e.g., Formspree) */
  formAction?: string;
}

const {
  title = 'Book Your Free Consultation',
  description = 'Let\'s discuss your project. Joe personally reviews every request and will be in touch within 1 business day.',
  successRedirectUrl = '/thank-you',
  formAction = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT_URL || 'https://formspree.io/f/yourformid',
} = Astro.props;

const serviceTypeOptions = [
  { value: 'painting', label: 'Painting Services' },
  { value: 'handy', label: 'Handy Services' },
  { value: 'both', label: 'Both Painting & Handy Services' },
];

const preferredContactOptions = [
  { value: 'phone', label: 'Phone Call' },
  { value: 'email', label: 'Email' },
];

// Client-side validation state (using basic JS for demonstration)
// In a real app, you might use a framework or dedicated validation library
let formErrors: Record<string, string> = {};

// Function to handle form submission (client-side)
const handleSubmit = async (event: Event) => {
  event.preventDefault();
  const form = event.target as HTMLFormElement;
  const formData = new FormData(form);

  // Basic client-side validation
  formErrors = {};
  if (!formData.get('fullName')) formErrors.fullName = 'Full Name is required.';
  if (!formData.get('email') || !/\S+@\S+\.\S+/.test(formData.get('email') as string)) formErrors.email = 'A valid Email Address is required.';
  if (!formData.get('phoneNumber') || !/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(formData.get('phoneNumber') as string)) formErrors.phoneNumber = 'A valid Phone Number is required.';
  if (!formData.get('projectType')) formErrors.projectType = 'Please select a Project Type.';
  if (!formData.get('serviceLocation')) formErrors.serviceLocation = 'Service Location is required.';
  if (!formData.get('projectDetails')) formErrors.projectDetails = 'Please provide Project Details.';
  if (!formData.get('preferredContact')) formErrors.preferredContact = 'Please select a Preferred Contact method.';

  if (Object.keys(formErrors).length > 0) {
    // Re-render component with errors (Astro won't re-render like this, need client:load or similar)
    // For this example, we'll assume a client-side framework handles this or rely on browser validation.
    console.error('Validation errors:', formErrors);
    alert('Please correct the errors in the form.'); // Fallback alert
    return;
  }

  const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
  const originalButtonText = submitButton.innerHTML;
  submitButton.disabled = true;
  submitButton.innerHTML = `<span class="inline-flex items-center"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Sending Request...</span>`;

  try {
    const response = await fetch(formAction, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
      },
      body: formData,
    });

    if (response.ok) {
      window.location.href = successRedirectUrl;
    } else {
      const errorData = await response.json();
      console.error('Form submission failed:', errorData);
      alert('Oops! Something went wrong. Please try again or call Joe directly at (760) 580-8173.');
    }
  } catch (error) {
    console.error('Network error:', error);
    alert('A network error occurred. Please check your connection or call Joe directly at (760) 580-8173.');
  } finally {
    submitButton.disabled = false;
    submitButton.innerHTML = originalButtonText;
  }
};
---

<div class="bg-surface rounded-lg p-6 md:p-8 shadow-md">
  <h2 class="font-heading text-2xl md:text-3xl font-bold text-text mb-2">
    {title}
  </h2>
  <p class="font-body text-base text-textMuted mb-6">
    {description}
  </p>

  <form method="POST" action={formAction} class="space-y-4" onsubmit="return false;" data-consultation-form>
    <Input
      label="Full Name"
      id="fullName"
      type="text"
      placeholder="John Doe"
      required
      errorMessage={formErrors.fullName}
    />
    <Input
      label="Email Address"
      id="email"
      type="email"
      placeholder="john.doe@example.com"
      required
      errorMessage={formErrors.email}
    />
    <Input
      label="Phone Number"
      id="phoneNumber"
      type="tel"
      placeholder="(760) 555-1234"
      required
      errorMessage={formErrors.phoneNumber}
    />
    <Select
      label="Project Type"
      id="projectType"
      options={serviceTypeOptions}
      placeholder="Select a service type"
      required
      errorMessage={formErrors.projectType}
    />
    <Input
      label="Service Location (City or Zip Code)"
      id="serviceLocation"
      type="text"
      placeholder="Carlsbad, CA or 92008"
      required
      errorMessage={formErrors.serviceLocation}
    />
    <Textarea
      label="Project Details"
      id="projectDetails"
      placeholder="e.g., Exterior house paint, 3 bedrooms, drywall repair needed."
      rows={4}
      required
      errorMessage={formErrors.projectDetails}
    />
    <RadioGroup
      label="Preferred Contact Method"
      name="preferredContact"
      options={preferredContactOptions}
      required
      errorMessage={formErrors.preferredContact}
    />
    <Input
      label="How Did You Hear About Joe? (Optional)"
      id="howDidYouHear"
      type="text"
      placeholder="e.g., Google, Friend's referral, Yelp"
      required={false}
    />

    <div class="pt-2">
      <Button type="submit" fullWidth size="lg">
        Request My Free Consultation
      </Button>
    </div>
  </form>
</div>

<script is:inline>
  // This script provides client-side form submission logic for Astro's SSG.
  // In a more complex SPA setup, a framework like React/Vue would handle state & validation.
  const formElement = document.querySelector('[data-consultation-form]');
  if (formElement) {
    formElement.addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);

      // Simple client-side validation for demonstration
      let hasError = false;
      const fields = ['fullName', 'email', 'phoneNumber', 'projectType', 'serviceLocation', 'projectDetails', 'preferredContact'];
      fields.forEach(fieldId => {
        const input = form.querySelector(`#${fieldId}`);
        const errorMessageElement = form.querySelector(`#${fieldId}-error`);
        if (input) {
          if (input.required && !formData.get(fieldId)) {
            input.classList.add('border-error');
            if (errorMessageElement) errorMessageElement.textContent = `${input.labels[0].textContent.replace('*', '').trim()} is required.`;
            hasError = true;
          } else if (fieldId === 'email' && !/\S+@\S+\.\S+/.test(formData.get(fieldId))) {
            input.classList.add('border-error');
            if (errorMessageElement) errorMessageElement.textContent = 'A valid Email Address is required.';
            hasError = true;
          } else if (fieldId === 'phoneNumber' && !/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(formData.get(fieldId))) {
            input.classList.add('border-error');
            if (errorMessageElement) errorMessageElement.textContent = 'A valid Phone Number is required.';
            hasError = true;
          } else {
            input.classList.remove('border-error');
            if (errorMessageElement) errorMessageElement.textContent = '';
          }
        }
      });

      if (hasError) {
        // If there's an error, prevent submission and scroll to first error
        const firstErrorField = form.querySelector('.border-error');
        if (firstErrorField) firstErrorField.focus();
        return;
      }

      const submitButton = form.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = `<span class="inline-flex items-center"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Sending Request...</span>`;

      try {
        const formAction = form.getAttribute('action');
        const response = await fetch(formAction, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
          },
          body: formData,
        });

        if (response.ok) {
          const successRedirectUrl = form.closest('[data-success-redirect-url]')?.dataset.successRedirectUrl || '/thank-you';
          window.location.href = successRedirectUrl;
        } else {
          const errorData = await response.json();
          console.error('Form submission failed:', errorData);
          alert('Oops! Something went wrong. Please try again or call Joe directly at (760) 580-8173.');
        }
      } catch (error) {
        console.error('Network error:', error);
        alert('A network error occurred. Please check your connection or call Joe directly at (760) 580-8173.');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
      }
    });
  }
</script>