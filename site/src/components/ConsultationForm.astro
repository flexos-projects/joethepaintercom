---
import Button from './ui/Button.astro';
import Input from './ui/Input.astro';
import Label from './ui/Label.astro';

interface Props {
  formId?: string;
  class?: string;
}

const {
  formId = 'consultation-form',
  class: className,
} = Astro.props;

// Use environment variable for the Formspree endpoint URL.
// Ensure PUBLIC_FORMSPREE_ENDPOINT_URL is set in .env or Vercel config.
const formAction = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT_URL || 'https://formspree.io/f/joethepainter-consultation-fallback'; // Fallback for dev if not set
---

<form
  id={formId}
  action={formAction}
  method="POST"
  class:list={['space-y-6', className]}
  aria-labelledby="consultation-form-title"
  novalidate
>
  <h2 id="consultation-form-title" class="sr-only">Book Your Free Consultation</h2>

  <Input
    label="Full Name"
    id="full-name"
    name="full-name"
    type="text"
    placeholder="John Doe"
    required
    autocomplete="name"
  />

  <Input
    label="Email Address"
    id="email"
    name="email"
    type="email"
    placeholder="john.doe@example.com"
    required
    autocomplete="email"
  />

  <Input
    label="Phone Number"
    id="phone"
    name="phone"
    type="tel"
    placeholder="(760) 555-1234"
    required
    autocomplete="tel"
  />

  <div>
    <Label for="service-type" required>Project Type</Label>
    <div class="relative mt-1">
      <select
        id="service-type"
        name="service-type"
        required
        class="block w-full border border-neutral-200 rounded-md py-3 pl-3 pr-10 text-base text-neutral-800 bg-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition"
        aria-describedby="service-type-description"
      >
        <option value="">Select a service type...</option>
        <option value="Painting Services">Painting Services</option>
        <option value="Handy Services">Handy Services</option>
        <option value="Both Painting & Handy Services">Both Painting & Handy Services</option>
      </select>
      <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2 text-neutral-500">
        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </span>
    </div>
    <p id="service-type-description" class="sr-only">Choose the primary type of service you need.</p>
  </div>

  <div>
    <Label for="project-description" required>Project Details</Label>
    <textarea
      id="project-description"
      name="project-description"
      rows={4}
      placeholder="Briefly describe your project, e.g., 'Exterior house paint, 3 bedrooms, drywall repair needed.'"
      required
      class="block w-full border border-neutral-200 rounded-md p-3 text-base text-neutral-800 bg-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition mt-1"
      aria-describedby="project-description-hint"
    ></textarea>
    <p id="project-description-hint" class="text-sm text-neutral-500 mt-1">
      Tell Joe about your project (e.g., "Exterior house paint, 3 bedrooms").
    </p>
  </div>

  <div>
    <Label as="legend" class="mb-2 text-sm font-medium text-neutral-800">Preferred Contact Method</Label>
    <div class="flex items-center space-x-4 mt-1" role="radiogroup" aria-labelledby="preferred-contact-label">
      <p id="preferred-contact-label" class="sr-only">How would you prefer Joe to reach out for your consultation?</p>
      <div class="flex items-center">
        <input
          id="contact-phone"
          name="preferred-contact"
          type="radio"
          value="Phone Call"
          required
          class="focus:ring-primary h-4 w-4 text-primary border-neutral-300"
        />
        <label for="contact-phone" class="ml-2 block text-sm text-neutral-800">Phone Call</label>
      </div>
      <div class="flex items-center">
        <input
          id="contact-email"
          name="preferred-contact"
          type="radio"
          value="Email"
          required
          class="focus:ring-primary h-4 w-4 text-primary border-neutral-300"
        />
        <label for="contact-email" class="ml-2 block text-sm text-neutral-800">Email</label>
      </div>
    </div>
  </div>

  <Input
    label="How Did You Hear About Joe?"
    id="referral-source"
    name="referral-source"
    type="text"
    placeholder="e.g., Google, Friend's referral, Yelp"
    autocomplete="off"
  />

  <Button variant="primary" size="lg" type="submit" class="w-full">
    Request My Free Consultation
  </Button>

  <!-- Placeholder for submission message -->
  <div id="form-status-message" class="mt-4 sr-only" role="status" aria-live="polite"></div>
</form>

<script is:inline>
  const form = document.getElementById('consultation-form');
  const statusMessage = document.getElementById('form-status-message');

  if (form) {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      // Basic client-side validation (browser's native HTML5 validation handles most)
      if (!form.checkValidity()) {
        statusMessage.textContent = 'Please fill out all required fields correctly.';
        statusMessage.classList.remove('sr-only');
        statusMessage.classList.add('text-error', 'block');
        statusMessage.focus(); // Move focus to the status message for screen readers
        return;
      }

      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Sending Request...';
        submitButton.classList.add('opacity-75', 'cursor-not-allowed');
      }

      // Simulate network request (replace with actual fetch to Formspree/backend)
      try {
        const response = await fetch(form.action, {
          method: form.method,
          body: new FormData(form),
          headers: {
            'Accept': 'application/json'
          }
        });

        if (response.ok) {
          statusMessage.textContent = 'Thank You! Your Free Consultation Request Has Been Received. Joe personally reviews every request and will be in touch within 1 business day to discuss your project and schedule your consultation. We appreciate your patience!';
          statusMessage.classList.remove('sr-only', 'text-error');
          statusMessage.classList.add('text-success', 'block'); // Ensure it's visible
          form.reset();
        } else {
          const data = await response.json();
          if (data?.errors) {
            statusMessage.textContent = `Error: ${data.errors.map(e => e.field).join(', ')} are invalid.`;
          } else {
            statusMessage.textContent = 'Oops! Something went wrong on our end. Please try again or call Joe directly at (760) 580-8173.';
          }
          statusMessage.classList.remove('sr-only', 'text-success');
          statusMessage.classList.add('text-error', 'block'); // Ensure it's visible
        }
      } catch (error) {
        statusMessage.textContent = 'A network error occurred. Please try again or call Joe directly at (760) 580-8173.';
        statusMessage.classList.remove('sr-only', 'text-success');
        statusMessage.classList.add('text-error', 'block'); // Ensure it's visible
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Request My Free Consultation';
          submitButton.classList.remove('opacity-75', 'cursor-not-allowed');
        }
        statusMessage.focus(); // Move focus to the status message for screen readers
      }
    });
  }
</script>