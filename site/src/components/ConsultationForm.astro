---
import Input from '@/components/ui/Input.astro';
import Label from '@/components/ui/Label.astro';
import Button from '@/components/ui/Button.astro';
import Textarea from '@/components/ui/Textarea.astro'; // Assuming a Textarea component exists

// Formspree endpoint from environment variables
const FORMSPREE_ENDPOINT_URL = import.meta.env.FORMSPREE_ENDPOINT_URL || 'YOUR_FORMSPREE_ENDPOINT_HERE';

// Ensure the Textarea component is defined as per task TASK-005 requirements.
// For now, I'll assume it exists or use a basic HTML textarea with Tailwind classes.
// If Textarea.astro is not created by TASK-005, it will need to be added.
---

<form
  action={FORMSPREE_ENDPOINT_URL}
  method="POST"
  class="space-y-6"
  id="consultation-form"
>
  <div>
    <Label for="fullName" required>Full Name</Label>
    <Input
      id="fullName"
      name="fullName"
      type="text"
      placeholder="John Doe"
      required
      autocomplete="name"
    />
    <p id="fullName-error" class="text-error text-sm mt-1 hidden" aria-live="polite"></p>
  </div>

  <div>
    <Label for="email" required>Email Address</Label>
    <Input
      id="email"
      name="email"
      type="email"
      placeholder="john.doe@example.com"
      required
      autocomplete="email"
    />
    <p id="email-error" class="text-error text-sm mt-1 hidden" aria-live="polite"></p>
  </div>

  <div>
    <Label for="phone" required>Phone Number</Label>
    <Input
      id="phone"
      name="phone"
      type="tel"
      placeholder="(XXX) XXX-XXXX"
      required
      autocomplete="tel"
    />
    <p id="phone-error" class="text-error text-sm mt-1 hidden" aria-live="polite"></p>
  </div>

  <div>
    <Label for="projectType" required>Project Type</Label>
    <div class="relative">
      <select
        id="projectType"
        name="projectType"
        required
        class="block w-full px-4 py-3 border rounded-md text-text-dark bg-surface border-border focus:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:border-transparent appearance-none"
      >
        <option value="">Select a service...</option>
        <option value="Painting Services">Painting Services</option>
        <option value="Handy Services">Handy Services</option>
        <option value="Both Painting & Handy Services">Both Painting & Handy Services</option>
      </select>
      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-text-muted">
        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </div>
    </div>
    <p id="projectType-error" class="text-error text-sm mt-1 hidden" aria-live="polite"></p>
  </div>

  <div>
    <Label for="serviceLocation" required>Service Location</Label>
    <Input
      id="serviceLocation"
      name="serviceLocation"
      type="text"
      placeholder="San Diego, CA"
      required
    />
    <p id="serviceLocation-error" class="text-error text-sm mt-1 hidden" aria-live="polite"></p>
  </div>

  <div>
    <Label for="projectDetails" required>Project Details</Label>
    <Textarea
      id="projectDetails"
      name="projectDetails"
      rows={5}
      placeholder="Describe your project (e.g., exterior house paint, drywall repair for living room, cabinet refinishing for kitchen)..."
      required
    />
    <p id="projectDetails-error" class="text-error text-sm mt-1 hidden" aria-live="polite"></p>
  </div>

  <fieldset>
    <legend class="block text-sm font-medium text-text-dark mb-3">Preferred Contact Method<span class="text-error ml-1">*</span></legend>
    <div class="flex items-center space-x-6">
      <div class="flex items-center">
        <input
          id="contactPhone"
          name="preferredContact"
          type="radio"
          value="Phone Call"
          required
          class="focus-visible:ring-primary h-4 w-4 text-primary border-gray-300"
        />
        <label for="contactPhone" class="ml-2 block text-base text-text-dark">Phone Call</label>
      </div>
      <div class="flex items-center">
        <input
          id="contactEmail"
          name="preferredContact"
          type="radio"
          value="Email"
          required
          class="focus-visible:ring-primary h-4 w-4 text-primary border-gray-300"
        />
        <label for="contactEmail" class="ml-2 block text-base text-text-dark">Email</label>
      </div>
    </div>
    <p id="preferredContact-error" class="text-error text-sm mt-1 hidden" aria-live="polite"></p>
  </fieldset>

  <div>
    <Label for="howDidYouHear">How Did You Hear About Joe?</Label>
    <Input
      id="howDidYouHear"
      name="howDidYouHear"
      type="text"
      placeholder="e.g., Google, Friend's referral, Yelp"
      required={false}
    />
  </div>

  <!-- reCAPTCHA placeholder - actual integration handled by TASK-025 -->
  <div class="g-recaptcha" data-sitekey="YOUR_RECAPTCHA_SITE_KEY" data-size="invisible"></div>
  <p id="recaptcha-error" class="text-error text-sm mt-1 hidden" aria-live="polite"></p>

  <Button type="submit" size="lg" variant="primary" class="w-full" id="submit-button">
    Request My Free Consultation
  </Button>
  <div id="form-status" class="mt-4 text-center text-lg hidden" aria-live="polite"></div>
</form>

<script is:inline>
  const form = document.getElementById('consultation-form');
  const submitButton = document.getElementById('submit-button');
  const formStatus = document.getElementById('form-status');

  const fields = [
    { id: 'fullName', validate: (val) => val.trim().length >= 2, message: 'Please enter your full name.' },
    { id: 'email', validate: (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val), message: 'Please enter a valid email address.' },
    { id: 'phone', validate: (val) => /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(val), message: 'Please enter a valid 10-digit phone number.' },
    { id: 'projectType', validate: (val) => val !== '', message: 'Please select a project type.' },
    { id: 'serviceLocation', validate: (val) => val.trim().length >= 3, message: 'Please enter your service location.' },
    { id: 'projectDetails', validate: (val) => val.trim().length >= 10, message: 'Please provide details about your project (min 10 characters).' },
  ];

  function showError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorElement = document.getElementById(`${fieldId}-error`);
    if (field && errorElement) {
      field.classList.add('border-error');
      field.setAttribute('aria-invalid', 'true');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }
  }

  function hideError(fieldId) {
    const field = document.getElementById(fieldId);
    const errorElement = document.getElementById(`${fieldId}-error`);
    if (field && errorElement) {
      field.classList.remove('border-error');
      field.removeAttribute('aria-invalid');
      errorElement.classList.add('hidden');
      errorElement.textContent = '';
    }
  }

  function validateField(fieldConfig) {
    const input = document.getElementById(fieldConfig.id);
    if (!input) return true;
    const value = input.value;
    const isValid = fieldConfig.validate(value);
    if (!isValid) {
      showError(fieldConfig.id, fieldConfig.message);
    } else {
      hideError(fieldConfig.id);
    }
    return isValid;
  }

  function validateRadioGroup(name, messageId) {
    const radioGroup = form.querySelectorAll(`input[name="${name}"]`);
    const isChecked = Array.from(radioGroup).some(radio => radio.checked);
    const errorElement = document.getElementById(messageId);

    if (!isChecked) {
      errorElement.textContent = 'Please select your preferred contact method.';
      errorElement.classList.remove('hidden');
      return false;
    } else {
      errorElement.classList.add('hidden');
      errorElement.textContent = '';
      return true;
    }
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault(); // Prevent default form submission

    let formIsValid = true;

    // Validate text/select/textarea fields
    for (const field of fields) {
      if (!validateField(field)) {
        formIsValid = false;
      }
    }

    // Validate radio buttons
    if (!validateRadioGroup('preferredContact', 'preferredContact-error')) {
      formIsValid = false;
    }

    if (!formIsValid) {
      // Focus on the first invalid field
      const firstInvalidField = form.querySelector('[aria-invalid="true"]');
      if (firstInvalidField) {
        firstInvalidField.focus();
      }
      formStatus.textContent = 'Please correct the errors in the form.';
      formStatus.classList.remove('hidden');
      formStatus.classList.add('text-error');
      return;
    }

    // --- reCAPTCHA execution (actual implementation handled by TASK-025) ---
    // For now, assume it always passes or is handled externally.
    // In TASK-025, this part will be replaced with actual grecaptcha.execute logic.
    const recaptchaToken = 'mock-recaptcha-token'; // Placeholder
    // --- END reCAPTCHA placeholder ---

    submitButton.textContent = 'Sending Request...';
    submitButton.disabled = true;
    formStatus.textContent = '';
    formStatus.classList.add('hidden');

    const formData = new FormData(form);
    formData.append('g-recaptcha-response', recaptchaToken); // Append reCAPTCHA token

    try {
      const response = await fetch(form.action, {
        method: form.method,
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        formStatus.textContent = 'Thank You! Your Free Consultation Request Has Been Received. Joe personally reviews every request and will be in touch within 1 business day.';
        formStatus.classList.remove('hidden', 'text-error');
        formStatus.classList.add('text-success');
        form.reset(); // Clear form fields
        // Optionally redirect to a thank you page
        // window.location.href = '/thank-you';
      } else {
        const data = await response.json();
        if (data?.errors) {
          formStatus.textContent = 'Error: ' + data.errors.map(e => e.message).join(', ');
        } else {
          formStatus.textContent = 'Oops! Something went wrong on our end. Please try again or call Joe directly at (760) 580-8173.';
        }
        formStatus.classList.remove('hidden', 'text-success');
        formStatus.classList.add('text-error');
      }
    } catch (error) {
      console.error('Form submission error:', error);
      formStatus.textContent = 'Oops! Something went wrong on our end. Please try again or call Joe directly at (760) 580-8173.';
      formStatus.classList.remove('hidden', 'text-success');
      formStatus.classList.add('text-error');
    } finally {
      submitButton.textContent = 'Request My Free Consultation';
      submitButton.disabled = false;
    }
  });

  // Add real-time validation feedback on blur
  fields.forEach(fieldConfig => {
    const input = document.getElementById(fieldConfig.id);
    if (input) {
      input.addEventListener('blur', () => validateField(fieldConfig));
      input.addEventListener('input', () => hideError(fieldConfig.id)); // Hide error on input
    }
  });

  form.querySelectorAll('input[name="preferredContact"]').forEach(radio => {
    radio.addEventListener('change', () => hideError('preferredContact-error'));
  });
</script>