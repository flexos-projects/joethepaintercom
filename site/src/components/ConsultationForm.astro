---
import Input from './ui/Input.astro';
import Label from './ui/Label.astro';
import Button from './ui/Button.astro';
import type { HTMLAttributes } from 'astro/types';

interface Props extends HTMLAttributes<'form'> {
  formId?: string;
  ctaText?: string;
}

const { formId = 'consultation-form', ctaText = 'Request My Free Consultation', ...attrs } = Astro.props;
---

<form id={formId} class="space-y-6" {...attrs}>
  <div>
    <Label for="fullName">Full Name</Label>
    <Input
      id="fullName"
      name="fullName"
      type="text"
      placeholder="John Doe"
      required
      minLength={2}
      pattern="[A-Za-z\s]+"
      title="Name should only contain letters and spaces."
    />
    <p id="fullName-error" class="hidden text-error text-sm mt-1"></p>
  </div>
  <div>
    <Label for="emailAddress">Email Address</Label>
    <Input
      id="emailAddress"
      name="emailAddress"
      type="email"
      placeholder="john.doe@example.com"
      required
    />
    <p id="emailAddress-error" class="hidden text-error text-sm mt-1"></p>
  </div>
  <div>
    <Label for="phoneNumber">Phone Number</Label>
    <Input
      id="phoneNumber"
      name="phoneNumber"
      type="tel"
      placeholder="(760) 555-1234"
      required
      pattern="^\(?([0-9]{3})\)?[-.●]?([0-9]{3})[-.●]?([0-9]{4})$"
      title="Please enter a valid US phone number format."
    />
    <p id="phoneNumber-error" class="hidden text-error text-sm mt-1"></p>
  </div>
  <div>
    <Label for="projectType">Project Type</Label>
    <div class="relative">
      <select
        id="projectType"
        name="projectType"
        required
        class="block w-full px-4 py-3 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-surface text-text text-base appearance-none pr-8 transition-colors duration-200"
        aria-describedby="projectType-error"
      >
        <option value="" disabled selected>Select a service...</option>
        <option value="painting">Painting Services</option>
        <option value="handy">Handy Services</option>
        <option value="both">Both Painting & Handy Services</option>
      </select>
      <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-text">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
    </div>
    <p id="projectType-error" class="hidden text-error text-sm mt-1"></p>
  </div>
  <div>
    <Label for="serviceLocation">Service Location</Label>
    <Input
      id="serviceLocation"
      name="serviceLocation"
      type="text"
      placeholder="Carlsbad, CA"
      required
      minLength={3}
    />
    <p id="serviceLocation-error" class="hidden text-error text-sm mt-1"></p>
  </div>
  <div>
    <Label for="projectDetails">Project Details</Label>
    <textarea
      id="projectDetails"
      name="projectDetails"
      rows={5}
      placeholder="Tell Joe about your project (e.g., 'Exterior house paint, 3 bedrooms')."
      required
      minLength={10}
      maxLength={500}
      class="w-full px-4 py-3 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-surface text-text text-base transition-colors duration-200"
      aria-describedby="projectDetails-error"
    ></textarea>
    <p id="projectDetails-error" class="hidden text-error text-sm mt-1"></p>
  </div>
  <fieldset>
    <legend class="block text-sm font-medium text-text mb-2">Preferred Contact Method</legend>
    <div class="flex flex-col sm:flex-row gap-4">
      <div class="flex items-center">
        <input
          id="contactPhone"
          name="preferredContact"
          type="radio"
          value="phone"
          required
          class="h-4 w-4 text-primary border-border focus:ring-primary checked:bg-primary"
        />
        <Label for="contactPhone" class="ml-2 mb-0">Phone Call</Label>
      </div>
      <div class="flex items-center">
        <input
          id="contactEmail"
          name="preferredContact"
          type="radio"
          value="email"
          class="h-4 w-4 text-primary border-border focus:ring-primary checked:bg-primary"
        />
        <Label for="contactEmail" class="ml-2 mb-0">Email</Label>
      </div>
    </div>
    <p id="preferredContact-error" class="hidden text-error text-sm mt-1"></p>
  </fieldset>
  <div>
    <Label for="howDidYouHear">How Did You Hear About Joe? <span class="text-textMuted">(Optional)</span></Label>
    <Input
      id="howDidYouHear"
      name="howDidYouHear"
      type="text"
      placeholder="Google, Friend's referral, Yelp, etc."
      maxLength={100}
    />
  </div>

  <!-- Hidden reCAPTCHA field -->
  <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response-consultation" />

  <Button type="submit" variant="primary" size="lg" class="w-full">
    {ctaText}
  </Button>
  <p id="form-submission-error" class="hidden text-error text-sm text-center mt-4" role="alert"></p>
</form>

<script is:inline>
  const formConsultation = document.getElementById('consultation-form');
  const submitButtonConsultation = formConsultation?.querySelector('button[type="submit"]');
  const recaptchaInputConsultation = document.getElementById('g-recaptcha-response-consultation');
  const formSubmissionErrorConsultation = document.getElementById('form-submission-error');

  // Basic client-side validation display
  const validateField = (input) => {
    const errorElement = document.getElementById(`${input.id}-error`);
    if (!errorElement) return true; // No error element to display error

    if (input.checkValidity()) {
      errorElement.classList.add('hidden');
      input.classList.remove('border-error');
      return true;
    } else {
      errorElement.textContent = input.validationMessage || `Please enter a valid ${input.id.replace(/([A-Z])/g, ' $1').toLowerCase()}.`;
      errorElement.classList.remove('hidden');
      input.classList.add('border-error');
      return false;
    }
  };

  formConsultation?.addEventListener('input', (event) => {
    validateField(event.target);
  });

  formConsultation?.addEventListener('submit', async (event) => {
    event.preventDefault();
    formSubmissionErrorConsultation.classList.add('hidden'); // Hide previous errors

    let formIsValid = true;
    const formFields = formConsultation.querySelectorAll('input[required], select[required], textarea[required]');
    formFields.forEach(field => {
      if (!validateField(field)) {
        formIsValid = false;
      }
    });

    // Handle radio button validation separately if needed (e.g. for 'preferredContact')
    const preferredContactRadios = formConsultation.querySelectorAll('input[name="preferredContact"]');
    const preferredContactError = document.getElementById('preferredContact-error');
    if (preferredContactRadios.length > 0) {
      const isAnyRadioChecked = Array.from(preferredContactRadios).some(radio => radio.checked);
      if (!isAnyRadioChecked) {
        formIsValid = false;
        if (preferredContactError) {
          preferredContactError.textContent = 'Please select a preferred contact method.';
          preferredContactError.classList.remove('hidden');
        }
      } else {
        if (preferredContactError) preferredContactError.classList.add('hidden');
      }
    }

    if (!formIsValid) {
      formSubmissionErrorConsultation.textContent = 'Please correct the highlighted fields.';
      formSubmissionErrorConsultation.classList.remove('hidden');
      return;
    }

    if (submitButtonConsultation) {
      submitButtonConsultation.disabled = true;
      submitButtonConsultation.textContent = 'Sending Request...';
      submitButtonConsultation.classList.add('opacity-70', 'cursor-not-allowed');
    }

    // reCAPTCHA integration
    if (import.meta.env.PROD && typeof grecaptcha !== 'undefined' && grecaptcha.ready) {
      try {
        const token = await grecaptcha.execute(import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY, { action: 'submit_consultation' });
        if (recaptchaInputConsultation) {
          recaptchaInputConsultation.value = token;
        } else {
          throw new Error('reCAPTCHA input field not found.');
        }
      } catch (error) {
        console.error('reCAPTCHA execution failed:', error);
        formSubmissionErrorConsultation.textContent = 'Failed to verify reCAPTCHA. Please try again.';
        formSubmissionErrorConsultation.classList.remove('hidden');
        if (submitButtonConsultation) {
          submitButtonConsultation.disabled = false;
          submitButtonConsultation.textContent = 'Request My Free Consultation';
          submitButtonConsultation.classList.remove('opacity-70', 'cursor-not-allowed');
        }
        return;
      }
    } else if (import.meta.env.PROD) {
      // In production, if grecaptcha is not available, prevent submission
      console.error('reCAPTCHA script not loaded. Cannot submit form.');
      formSubmissionErrorConsultation.textContent = 'reCAPTCHA verification failed to load. Please refresh the page and try again.';
      formSubmissionErrorConsultation.classList.remove('hidden');
      if (submitButtonConsultation) {
        submitButtonConsultation.disabled = false;
        submitButtonConsultation.textContent = 'Request My Free Consultation';
        submitButtonConsultation.classList.remove('opacity-70', 'cursor-not-allowed');
      }
      return;
    }

    // Prepare form data for fetch
    const formData = new FormData(formConsultation);
    const data = Object.fromEntries(formData.entries());

    try {
      const response = await fetch('/api/submit-form', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        window.location.href = '/thank-you';
      } else {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Oops! Something went wrong on our end. Please try again or call Joe directly at (760) 580-8173.');
      }
    } catch (error) {
      console.error('Form submission error:', error);
      formSubmissionErrorConsultation.textContent = error.message || 'There was an issue submitting your request. Please try again or call Joe directly at (760) 580-8173.';
      formSubmissionErrorConsultation.classList.remove('hidden');
    } finally {
      if (submitButtonConsultation) {
        submitButtonConsultation.disabled = false;
        submitButtonConsultation.textContent = 'Request My Free Consultation';
        submitButtonConsultation.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    }
  });
</script>