---
import Input from './ui/Input.astro';
import Label from './ui/Label.astro';
import Button from './ui/Button.astro';

interface Props {
  formId: string;
  title?: string;
  description?: string;
}

const { formId, title = "Book Your Free Consultation", description = "Let's discuss your project and bring your vision to life. No pressure, just expert advice." } = Astro.props;

const FORMSPREE_ENDPOINT = import.meta.env.PUBLIC_FORMSPREE_ENDPOINT;
---

<div class="bg-surface rounded-lg p-6 sm:p-8 shadow-md">
  <h3 class="font-heading text-2xl font-semibold text-text-dark mb-2">{title}</h3>
  <p class="text-text-muted mb-6">{description}</p>

  <form id={formId} action={FORMSPREE_ENDPOINT} method="POST" class="space-y-4" novalidate>
    <Input id="full-name" name="name" type="text" label="Full Name" placeholder="John Doe" required autocomplete="name" minlength={2} pattern="[a-zA-Z\\s.-]+" />
    <p id="full-name-error" class="validation-error-message text-error text-sm mt-1 hidden" aria-live="polite"></p>

    <Input id="email-address" name="email" type="email" label="Email Address" placeholder="john.doe@example.com" required autocomplete="email" />
    <p id="email-address-error" class="validation-error-message text-error text-sm mt-1 hidden" aria-live="polite"></p>

    <Input id="phone-number" name="phone" type="tel" label="Phone Number" placeholder="(760) 555-1234" required autocomplete="tel" pattern="^(\+1)?[\s.-]?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$" />
    <p id="phone-number-error" class="validation-error-message text-error text-sm mt-1 hidden" aria-live="polite"></p>

    <div>
      <Label for="project-type" text="Project Type" required />
      <select
        id="project-type"
        name="projectType"
        required
        class="w-full px-4 py-3 font-body text-base text-text-dark bg-surface
               border border-border rounded-md
               focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary
               disabled:bg-background disabled:cursor-not-allowed disabled:text-text-subtle"
        aria-invalid="false"
      >
        <option value="">Select a service...</option>
        <option value="Painting Services">Painting Services</option>
        <option value="Handy Services">Handy Services</option>
        <option value="Both Painting & Handy Services">Both Painting & Handy Services</option>
      </select>
      <p id="project-type-error" class="validation-error-message text-error text-sm mt-1 hidden" aria-live="polite"></p>
    </div>

    <Input id="service-location" name="location" type="text" label="Service Location (City/Zip)" placeholder="Carlsbad, CA 92008" required autocomplete="address-level2" minlength={3} />
    <p id="service-location-error" class="validation-error-message text-error text-sm mt-1 hidden" aria-live="polite"></p>

    <div>
      <Label for="project-details" text="Project Details" required />
      <textarea
        id="project-details"
        name="projectDetails"
        rows={4}
        placeholder="Tell Joe about your project (e.g., 'Exterior house paint, 3 bedrooms, minor wood rot repair')."
        required
        minlength={10}
        maxlength={500}
        class="w-full px-4 py-3 font-body text-base text-text-dark bg-surface
               border border-border rounded-md resize-y
               focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary
               placeholder-text-muted transition-all duration-150 ease-in-out
               disabled:bg-background disabled:cursor-not-allowed disabled:text-text-subtle"
        aria-invalid="false"
      ></textarea>
      <p id="project-details-error" class="validation-error-message text-error text-sm mt-1 hidden" aria-live="polite"></p>
    </div>

    <div>
      <Label text="Preferred Contact Method" required />
      <div id="preferred-contact-group" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 mt-2" role="radiogroup" aria-labelledby="preferred-contact-label">
        <span id="preferred-contact-label" class="sr-only">Preferred Contact Method</span>
        <label for="contact-phone" class="inline-flex items-center cursor-pointer">
          <input type="radio" id="contact-phone" name="preferredContact" value="Phone Call" class="form-radio text-primary focus:ring-primary" checked required />
          <span class="ml-2 text-text-dark">Phone Call</span>
        </label>
        <label for="contact-email" class="inline-flex items-center cursor-pointer">
          <input type="radio" id="contact-email" name="preferredContact" value="Email" class="form-radio text-primary focus:ring-primary" required />
          <span class="ml-2 text-text-dark">Email</span>
        </label>
      </div>
      <p id="preferred-contact-group-error" class="validation-error-message text-error text-sm mt-1 hidden" aria-live="polite"></p>
    </div>

    <Input id="how-heard" name="howHeard" type="text" label="How Did You Hear About Joe? (Optional)" placeholder="Google, Referral, Yelp, etc." autocomplete="off" />
    <p id="how-heard-error" class="validation-error-message text-error text-sm mt-1 hidden" aria-live="polite"></p>

    <div class="text-sm text-text-muted">
      This site is protected by reCAPTCHA and the Google
      <a href="https://policies.google.com/privacy" class="text-primary hover:underline" target="_blank" rel="noopener noreferrer">Privacy Policy</a> and
      <a href="https://policies.google.com/terms" class="text-primary hover:underline" target="_blank" rel="noopener noreferrer">Terms of Service</a> apply.
    </div>

    <Button type="submit" variant="primary" size="lg" class="w-full mt-6">
      Request My Free Consultation
    </Button>
  </form>
</div>

<script is:inline>
  const form = document.getElementById('{formId}');
  if (form) {
    const submitButton = form.querySelector('button[type="submit"]');

    const showValidationError = (input, message) => {
      const errorId = `${input.id}-error`;
      let errorElement = document.getElementById(errorId);

      // If the error element doesn't exist (e.g., for radio groups), create it
      if (!errorElement) {
        errorElement = document.createElement('p');
        errorElement.id = errorId;
        errorElement.classList.add('validation-error-message', 'text-error', 'text-sm', 'mt-1');
        input.parentNode.insertBefore(errorElement, input.nextSibling); // Insert after the input
      }

      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
      input.classList.add('border-error');
      input.setAttribute('aria-invalid', 'true');
      input.setAttribute('aria-describedby', errorId);
    };

    const hideValidationError = (input) => {
      const errorId = `${input.id}-error`;
      const errorElement = document.getElementById(errorId);
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.classList.add('hidden');
      }
      input.classList.remove('border-error');
      input.setAttribute('aria-invalid', 'false');
      input.removeAttribute('aria-describedby');
    };

    form.addEventListener('submit', async function (event) {
      event.preventDefault(); // Prevent default form submission

      // Clear all previous errors
      form.querySelectorAll('.validation-error-message').forEach(el => el.classList.add('hidden'));
      form.querySelectorAll('.border-error').forEach(el => el.classList.remove('border-error'));
      form.querySelectorAll('[aria-invalid="true"]').forEach(el => el.setAttribute('aria-invalid', 'false'));
      form.querySelectorAll('[aria-describedby]').forEach(el => el.removeAttribute('aria-describedby'));

      let isValid = true;

      // Validate Full Name
      const nameInput = form.querySelector('#full-name');
      if (!nameInput.value.trim()) {
        showValidationError(nameInput, 'Full Name is required.');
      } else if (nameInput.value.trim().length < 2) {
        showValidationError(nameInput, 'Full Name must be at least 2 characters.');
      } else if (!/^[a-zA-Z\s.-]+$/.test(nameInput.value.trim())) {
        showValidationError(nameInput, 'Full Name can only contain letters, spaces, hyphens, and dots.');
      } else {
        hideValidationError(nameInput);
      }

      // Validate Email Address
      const emailInput = form.querySelector('#email-address');
      if (!emailInput.value.trim()) {
        showValidationError(emailInput, 'Email Address is required.');
      } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim())) {
        showValidationError(emailInput, 'Please enter a valid email address.');
      } else {
        hideValidationError(emailInput);
      }

      // Validate Phone Number
      const phoneInput = form.querySelector('#phone-number');
      if (!phoneInput.value.trim()) {
        showValidationError(phoneInput, 'Phone Number is required.');
      } else if (!/^(\+1)?[\s.-]?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/.test(phoneInput.value.trim())) {
        showValidationError(phoneInput, 'Please enter a valid US phone number (e.g., (760) 555-1234).');
      } else {
        hideValidationError(phoneInput);
      }

      // Validate Project Type
      const projectTypeSelect = form.querySelector('#project-type');
      if (!projectTypeSelect.value) {
        showValidationError(projectTypeSelect, 'Please select a Project Type.');
      } else {
        hideValidationError(projectTypeSelect);
      }

      // Validate Service Location
      const locationInput = form.querySelector('#service-location');
      if (!locationInput.value.trim()) {
        showValidationError(locationInput, 'Service Location is required.');
      } else if (locationInput.value.trim().length < 3) {
        showValidationError(locationInput, 'Service Location must be at least 3 characters.');
      } else {
        hideValidationError(locationInput);
      }

      // Validate Project Details
      const projectDetailsTextarea = form.querySelector('#project-details');
      if (!projectDetailsTextarea.value.trim()) {
        showValidationError(projectDetailsTextarea, 'Project Details are required.');
      } else if (projectDetailsTextarea.value.trim().length < 10) {
        showValidationError(projectDetailsTextarea, 'Project Details must be at least 10 characters.');
      } else if (projectDetailsTextarea.value.trim().length > 500) {
        showValidationError(projectDetailsTextarea, 'Project Details cannot exceed 500 characters.');
      } else {
        hideValidationError(projectDetailsTextarea);
      }

      // Validate Preferred Contact Method (radio buttons)
      const preferredContactRadios = form.querySelectorAll('input[name="preferredContact"]');
      let preferredContactSelected = false;
      preferredContactRadios.forEach(radio => {
        if (radio.checked) {
          preferredContactSelected = true;
        }
      });

      const preferredContactErrorElement = document.getElementById('preferred-contact-group-error');
      if (!preferredContactSelected) {
          if (preferredContactErrorElement) {
              preferredContactErrorElement.textContent = 'Please select a preferred contact method.';
              preferredContactErrorElement.classList.remove('hidden');
          }
          isValid = false;
      } else {
          if (preferredContactErrorElement) {
              preferredContactErrorElement.textContent = '';
              preferredContactErrorElement.classList.add('hidden');
          }
      }

      // Re-check isValid after all validations
      isValid = !form.querySelector('.border-error');

      if (!isValid) {
        // Find the first invalid element and scroll to it
        const firstInvalid = form.querySelector('.border-error');
        if (firstInvalid) {
          firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstInvalid.focus();
        }
        return;
      }

      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-3 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending Request...</span>';


      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // Simulate reCAPTCHA token generation (actual reCAPTCHA v3 would integrate here)
      data['g-recaptcha-response'] = 'mock-recaptcha-token';

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          window.location.href = '/thank-you';
        } else {
          const errorData = await response.json();
          alert('Oops! Something went wrong submitting your form: ' + (errorData.message || 'Please try again.'));
          submitButton.disabled = false;
          submitButton.textContent = 'Request My Free Consultation';
        }
      } catch (error) {
        console.error('Submission error:', error);
        alert('Failed to connect to the server. Please try again later.');
        submitButton.disabled = false;
        submitButton.textContent = 'Request My Free Consultation';
      }
    });
  }
</script>