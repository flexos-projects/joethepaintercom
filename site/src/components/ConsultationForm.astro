---
import Input from './ui/Input.astro';
import Label from './ui/Label.astro';
import Button from './ui/Button.astro';
import type { HTMLAttributes } from 'astro/types';

interface FormProps extends HTMLAttributes<'form'> {
  formId: string; // Unique ID for the form, for Formspree endpoint
  onSuccess?: string; // Optional URL to redirect to on success
  onClose?: () => void; // For modal usage
}

const { formId, onSuccess, onClose, ...rest } = Astro.props;

// Placeholder for Formspree endpoint. Replace with actual Formspree endpoint in production.
const formspreeEndpoint = `https://formspree.io/f/${formId}`;

// Client-side script for form submission feedback and validation
// This script needs to be inline or client:load for dynamic behavior
---
<form
  id={`form-${formId}`}
  action={formspreeEndpoint}
  method="POST"
  class="space-y-6"
  data-on-success={onSuccess}
  {...rest}
>
  <h2 class="font-heading text-3xl font-bold text-text text-center mb-6">Book Your Free Consultation</h2>
  <p class="text-textMuted text-center mb-8">
    Tell us about your project, and Joe will get in touch to discuss your needs and provide a no-obligation estimate.
  </p>

  <Input
    label="Full Name"
    name="name"
    type="text"
    placeholder="John Doe"
    required
  />

  <Input
    label="Email Address"
    name="email"
    type="email"
    placeholder="john.doe@example.com"
    required
  />

  <Input
    label="Phone Number"
    name="phone"
    type="tel"
    placeholder="(760) 555-1234"
    required
  />

  <div>
    <Label for="service-type" required>Project Type</Label>
    <select
      id="service-type"
      name="service_type"
      required
      class="w-full px-4 py-3 border border-border rounded-md text-text bg-surface focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-colors-transform"
    >
      <option value="">Select a service type...</option>
      <option value="painting">Painting Services</option>
      <option value="handy_services">Handy Services</option>
      <option value="both">Both Painting & Handy Services</option>
    </select>
    <p id="service-type-error" class="text-error text-sm mt-1 hidden" role="alert"></p>
  </div>

  <Input
    label="Service Location (City or Zip Code)"
    name="location"
    type="text"
    placeholder="Carlsbad, CA or 92008"
    required
  />

  <div>
    <Label for="project-description" required>Project Details</Label>
    <textarea
      id="project-description"
      name="project_description"
      rows={5}
      placeholder="Describe your project here (e.g., exterior house painting, drywall repair in living room)"
      required
      class="w-full px-4 py-3 border border-border rounded-md text-text bg-surface placeholder:text-textMuted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all-colors-transform"
      aria-describedby="project-description-error"
    ></textarea>
    <p id="project-description-error" class="text-error text-sm mt-1 hidden" role="alert"></p>
  </div>

  <fieldset class="mb-4">
    <legend class="block text-sm font-medium text-text mb-1.5">Preferred Contact Method <span class="text-error ml-1" aria-hidden="true">*</span></legend>
    <div class="mt-2 space-y-2">
      <div class="flex items-center">
        <input
          id="contact-phone"
          name="preferred_contact"
          type="radio"
          value="phone"
          required
          class="h-4 w-4 text-primary border-border focus:ring-primary"
        />
        <label for="contact-phone" class="ml-2 block text-base text-text">Phone Call</label>
      </div>
      <div class="flex items-center">
        <input
          id="contact-email"
          name="preferred_contact"
          type="radio"
          value="email"
          required
          class="h-4 w-4 text-primary border-border focus:ring-primary"
        />
        <label for="contact-email" class="ml-2 block text-base text-text">Email</label>
      </div>
    </div>
    <p id="preferred-contact-error" class="text-error text-sm mt-1 hidden" role="alert"></p>
  </fieldset>

  <input type="text" name="_gotcha" class="hidden" tabindex="-1" autocomplete="off" /> <!-- Honeypot field -->

  <Button type="submit" variant="primary" size="lg" fullWidth disabled={false}>
    Request My Free Consultation
  </Button>

  <div id={`form-status-${formId}`} role="status" aria-live="polite" class="mt-4 text-center"></div>
</form>

<script is:inline>
  const form = document.getElementById('form-{formId}');
  const statusDiv = document.getElementById('form-status-{formId}');
  const submitButton = form.querySelector('button[type="submit"]');

  // Basic client-side validation for required fields
  function validateForm() {
    let isValid = true;
    form.querySelectorAll('[required]').forEach(input => {
      const errorElement = document.getElementById(`${input.id}-error`) || input.nextElementSibling; // Generic error or next p tag
      if (input.type === 'radio') {
        const radioGroup = form.querySelector(`input[name="${input.name}"]:checked`);
        if (!radioGroup) {
          isValid = false;
          input.closest('fieldset')?.querySelector('[role="alert"]').textContent = 'Please select a contact method.';
          input.closest('fieldset')?.querySelector('[role="alert"]').classList.remove('hidden');
          // No specific border for radios, but ensure fieldset is visually distinct on error if needed
        } else {
          input.closest('fieldset')?.querySelector('[role="alert"]').textContent = '';
          input.closest('fieldset')?.querySelector('[role="alert"]').classList.add('hidden');
        }
      } else if (!input.value.trim()) {
        isValid = false;
        input.classList.add('border-error');
        if (errorElement && errorElement.tagName === 'P' && errorElement.getAttribute('role') === 'alert') {
          errorElement.textContent = `${input.previousElementSibling?.textContent.replace('*', '').trim()} is required.`;
          errorElement.classList.remove('hidden');
        }
      } else {
        input.classList.remove('border-error');
        if (errorElement && errorElement.tagName === 'P' && errorElement.getAttribute('role') === 'alert') {
          errorElement.textContent = '';
          errorElement.classList.add('hidden');
        }
      }
    });
    return isValid;
  }

  form.addEventListener('input', (event) => {
    const input = event.target;
    if (input.hasAttribute('required')) {
      if (input.type === 'radio') {
        const radioGroup = form.querySelector(`input[name="${input.name}"]:checked`);
        if (radioGroup) {
          input.closest('fieldset')?.querySelector('[role="alert"]').textContent = '';
          input.closest('fieldset')?.querySelector('[role="alert"]').classList.add('hidden');
        }
      } else if (input.value.trim()) {
        input.classList.remove('border-error');
        const errorElement = document.getElementById(`${input.id}-error`);
        if (errorElement) errorElement.classList.add('hidden');
      }
    }
  });


  form.addEventListener('submit', async (event) => {
    event.preventDefault(); // Prevent default form submission

    if (!validateForm()) {
      statusDiv.innerHTML = '<p class="text-error">Please fill out all required fields.</p>';
      return;
    }

    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Sending Request...</span>';
    statusDiv.innerHTML = '';

    try {
      const response = await fetch(form.action, {
        method: form.method,
        body: new FormData(form),
        headers: {
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        statusDiv.innerHTML = '<p class="text-success">Thank You! Your request has been received. Joe will contact you shortly.</p>';
        form.reset();
        // If in a modal and onClose is provided, call it after a short delay
        if (typeof {onClose} === 'function') {
          setTimeout(() => {
            // Need to pass a function reference, not an object literal
            // This part might need adjustment if onClose is a direct prop in Astro
            // For now, it's a string, so we'll rely on redirect or manual close
          }, 2000);
        }
        const successUrl = form.dataset.onSuccess;
        if (successUrl) {
          window.location.href = successUrl;
        }
      } else {
        const data = await response.json();
        if (data.errors) {
          statusDiv.innerHTML = `<p class="text-error">Error: ${data.errors.map(e => e.field).join(', ')} failed validation.</p>`;
        } else {
          statusDiv.innerHTML = '<p class="text-error">Oops! Something went wrong. Please try again or call Joe directly.</p>';
        }
      }
    } catch (error) {
      statusDiv.innerHTML = '<p class="text-error">Network error. Please try again later.</p>';
      console.error('Form submission error:', error);
    } finally {
      submitButton.disabled = false;
      submitButton.innerHTML = 'Request My Free Consultation';
    }
  });
</script>
---