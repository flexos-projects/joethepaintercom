---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import CtaBlock from '@/components/sections/CtaBlock.astro';
import { generateFAQPageSchema } from '@/utils/seo';

// Fetch FAQ content from collections, filtering by category ID
const generalFaqs = await getCollection('faqs', ({ id }) => id === 'general');
const paintingFaqs = await getCollection('faqs', ({ id }) => id === 'painting');
const handymanFaqs = await getCollection('faqs', ({ id }) => id === 'handyman');

// Combine all questions for the FAQPage schema. Ensure safe access to questions array.
const allQuestions = [
  ...(generalFaqs[0]?.data.questions || []),
  ...(paintingFaqs[0]?.data.questions || []),
  ...(handymanFaqs[0]?.data.questions || []),
];

// Define SEO metadata for the FAQ page
const pageSeo = {
  title: "Frequently Asked Questions | Joe the Painter",
  description: "Find answers to common questions about Joe the Painter's licensed painting and handyman services, estimates, service areas, and more in San Diego County.",
  keywords: ["FAQ painter san diego", "handyman questions", "licensed contractor faq", "painting process", "service area"],
  ogImage: "/images/social-share-faq.jpg" // Social share image for FAQ page
};
---

<BaseLayout seo={pageSeo}>
  {/* Inject JSON-LD Schema.org for FAQPage structured data */}
  <Fragment slot="head-schema">
    <script type="application/ld+json">
      {JSON.stringify(generateFAQPageSchema(allQuestions))}
    </script>
  </Fragment>

  <section class="container mx-auto px-4 py-16 md:py-24">
    <h1 class="text-center text-4xl md:text-5xl font-heading font-bold text-text-dark mb-12">
      Frequently Asked Questions
    </h1>
    <p class="text-center text-lg md:text-xl text-text-muted max-w-3xl mx-auto mb-16">
      Have questions about our painting or handyman services? We've compiled a list of common inquiries to provide you with quick and helpful answers. We believe in clear communication and transparency, ensuring you feel confident and informed every step of the way.
    </p>

    <div class="max-w-4xl mx-auto space-y-16">
      {/* Render General FAQs if available */}
      {generalFaqs.length > 0 && (
        <div>
          <h2 class="text-3xl font-heading font-semibold text-text-dark mb-8 text-center">
            {generalFaqs[0].data.category}
          </h2>
          <div class="space-y-4">
            {generalFaqs[0].data.questions.map((faq) => (
              <details class="bg-surface p-6 rounded-lg shadow-sm group">
                <summary class="flex justify-between items-center cursor-pointer text-xl font-medium text-text-dark">
                  {faq.question}
                  <svg class="w-6 h-6 transform transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                {/* Render RichText answer as HTML */}
                <div class="prose prose-sm max-w-none mt-4 text-text-muted leading-relaxed">
                  <Fragment set:html={faq.answer} />
                </div>
              </details>
            ))}
          </div>
        </div>
      )}

      {/* Render Painting FAQs if available */}
      {paintingFaqs.length > 0 && (
        <div>
          <h2 class="text-3xl font-heading font-semibold text-text-dark mb-8 text-center">
            {paintingFaqs[0].data.category}
          </h2>
          <div class="space-y-4">
            {paintingFaqs[0].data.questions.map((faq) => (
              <details class="bg-surface p-6 rounded-lg shadow-sm group">
                <summary class="flex justify-between items-center cursor-pointer text-xl font-medium text-text-dark">
                  {faq.question}
                  <svg class="w-6 h-6 transform transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                {/* Render RichText answer as HTML */}
                <div class="prose prose-sm max-w-none mt-4 text-text-muted leading-relaxed">
                  <Fragment set:html={faq.answer} />
                </div>
              </details>
            ))}
          </div>
        </div>
      )}

      {/* Render Handyman FAQs if available */}
      {handymanFaqs.length > 0 && (
        <div>
          <h2 class="text-3xl font-heading font-semibold text-text-dark mb-8 text-center">
            {handymanFaqs[0].data.category}
          </h2>
          <div class="space-y-4">
            {handymanFaqs[0].data.questions.map((faq) => (
              <details class="bg-surface p-6 rounded-lg shadow-sm group">
                <summary class="flex justify-between items-center cursor-pointer text-xl font-medium text-text-dark">
                  {faq.question}
                  <svg class="w-6 h-6 transform transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </summary>
                {/* Render RichText answer as HTML */}
                <div class="prose prose-sm max-w-none mt-4 text-text-muted leading-relaxed">
                  <Fragment set:html={faq.answer} />
                </div>
              </details>
            ))}
          </div>
        </div>
      )}
    </div>

    <div class="text-center mt-16">
      <h2 class="text-3xl font-heading font-semibold text-text-dark mb-6">
        Didn't Find Your Answer?
      </h2>
      <a href="/contact" class="btn btn-primary btn-lg">
        Contact Joe Directly &rarr;
      </a>
    </div>
  </section>

  <CtaBlock />
</BaseLayout>