---
/**
 * Project Portfolio Gallery Page
 * /our-work
 */

import BaseLayout from '@layouts/BaseLayout.astro';
import ProjectCard from '@components/ProjectCard.astro';
import CTABanner from '@components/sections/CTABanner.astro';
import { getCollection } from 'astro:content';

// Page metadata
const meta = {
  title: 'Our Work | Joe the Painter: San Diego Project Portfolio',
  description: 'Explore Joe the Painter\'s completed projects in San Diego County. See stunning before-and-after transformations for painting and handyman services.',
  ogImage: '/images/social-share-default.jpg', // Use default from BaseLayout or specific if available
};

// Fetch all published projects, sorted by date (newest first)
const allProjects = (await getCollection('projects', ({ data }) => data.published))
  .sort((a, b) => b.data.projectDate.valueOf() - a.data.projectDate.valueOf());

// Define categories for filtering
const categories = ['All', 'Painting', 'Handy', 'Combined'];

// Client-side script for filtering projects
// This script needs to run on the client after the page loads.
// It will dynamically show/hide project cards based on the selected category.
---

<BaseLayout {...meta}>
  <main class="flex-1">
    <section class="container mx-auto px-4 py-12 md:py-16" aria-labelledby="portfolio-heading">
      <h1 id="portfolio-heading" class="font-heading text-4xl md:text-5xl font-bold text-center mb-6 text-text-dark">
        Our Work: A Legacy of Craftsmanship
      </h1>
      <p class="text-lg md:text-xl text-text-muted text-center max-w-3xl mx-auto mb-12">
        Browse through our portfolio of completed painting and handyman projects across San Diego County. See the meticulous attention to detail and lasting quality Joe brings to every home and business.
      </p>

      {/* Category Filtering */}
      <div class="flex flex-wrap justify-center gap-3 mb-12" id="project-categories" client:load>
        {categories.map((category) => (
          <button
            type="button"
            class={`
              px-5 py-2 rounded-full font-body text-base font-semibold transition-all duration-200 ease-in-out
              ${category === 'All' ? 'bg-primary text-white' : 'bg-background text-text-dark hover:bg-border'}
              focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2
            `}
            data-category={category.toLowerCase()}
            aria-pressed={category === 'All' ? 'true' : 'false'}
            aria-label={`Show ${category} projects`}
          >
            {category}
          </button>
        ))}
      </div>

      {/* Project Grid */}
      <div id="project-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        {allProjects.map((project) => (
          <ProjectCard project={project} />
        ))}
      </div>

      {allProjects.length === 0 && (
        <div class="text-center py-12">
          <p class="text-xl text-text-muted">No projects found in the portfolio yet. Please check back soon!</p>
        </div>
      )}
    </section>

    {/* CTA Banner */}
    <CTABanner
      headline="Ready to Transform Your Space?"
      description="Let's discuss your vision. Joe the Painter delivers meticulous craftsmanship and reliable solutions for your home or business."
      ctaText="Book Your Free Consultation"
      ctaHref="/consultation"
      backgroundColor="secondary"
      image={{
        src: "/images/cta-banner-projects.webp", // Specific image for this CTA
        alt: "A beautifully painted interior room with natural light",
      }}
    />
  </main>
</BaseLayout>

<script is:inline>
  document.addEventListener('astro:after-swap', () => {
    const categoryButtons = document.querySelectorAll('#project-categories button');
    const projectGrid = document.getElementById('project-grid');
    const allProjectCards = projectGrid ? Array.from(projectGrid.querySelectorAll('[data-service-types]')) : [];

    if (categoryButtons.length === 0 || allProjectCards.length === 0) {
      return; // Exit if elements are not found
    }

    const filterProjects = (selectedCategory) => {
      allProjectCards.forEach(card => {
        const serviceTypes = card.dataset.serviceTypes ? card.dataset.serviceTypes.split(',') : [];
        const matchesCategory = selectedCategory === 'all' || serviceTypes.some(type => type.toLowerCase() === selectedCategory);

        if (matchesCategory) {
          card.style.display = 'block'; // Show card
        } else {
          card.style.display = 'none'; // Hide card
        }
      });
    };

    categoryButtons.forEach(button => {
      button.addEventListener('click', () => {
        const selectedCategory = button.dataset.category || 'all';

        // Update active state for buttons
        categoryButtons.forEach(btn => {
          if (btn.dataset.category === selectedCategory) {
            btn.classList.add('bg-primary', 'text-white');
            btn.classList.remove('bg-background', 'text-text-dark', 'hover:bg-border');
            btn.setAttribute('aria-pressed', 'true');
          } else {
            btn.classList.remove('bg-primary', 'text-white');
            btn.classList.add('bg-background', 'text-text-dark', 'hover:bg-border');
            btn.setAttribute('aria-pressed', 'false');
          }
        });

        filterProjects(selectedCategory);
      });
    });

    // Initial filter on page load (ensure "All" is active by default)
    const initialCategoryButton = document.querySelector('#project-categories button[data-category="all"]');
    if (initialCategoryButton) {
      initialCategoryButton.click();
    }
  });
</script>

<style>
  /* Page-specific styles only if needed, otherwise rely on Tailwind */
</style>