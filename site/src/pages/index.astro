---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Hero from '@/components/Hero.astro';
import AboutJoeSection from '@/components/sections/AboutJoeSection.astro';
import ServiceCardsGrid from '@/components/sections/ServiceCardsGrid.astro';
import TestimonialCarousel from '@/components/sections/TestimonialCarousel.astro';
import CtaBlock from '@/components/sections/CtaBlock.astro';
import { generateLocalBusinessSchema } from '@/utils/seo';

const services = await getCollection('services', ({ data }) => data.published);
const testimonials = await getCollection('testimonials', ({ data }) => data.featured);

// Calculate aggregate rating for LocalBusiness schema
let totalRating = 0;
let reviewCount = 0;
if (testimonials.length > 0) {
  testimonials.forEach(t => {
    totalRating += t.data.rating;
    reviewCount++;
  });
}
const aggregateRating = reviewCount > 0 ? {
  ratingValue: parseFloat((totalRating / reviewCount).toFixed(1)),
  reviewCount: reviewCount,
} : undefined;

const pageSeo = {
  title: "Joe the Painter: San Diego's Trusted Painting & Handy Services",
  description: "Your Home, My Craft. Done Right Since 2001. Meticulous painting and reliable handy services personally delivered by a licensed expert in San Diego County. Request a free consultation!",
  keywords: ["Joe the Painter", "San Diego painting", "handyman San Diego", "licensed contractor", "home renovation", "exterior painting", "interior painting", "drywall repair", "Carlsbad", "Encinitas", "Vista"],
  ogImage: "/images/hero-home.webp" // Specific image for homepage OG
};
---

<BaseLayout seo={pageSeo}>
  <Fragment slot="head-schema">
    <script type="application/ld+json">
      {JSON.stringify(generateLocalBusinessSchema(Astro, undefined, aggregateRating))}
    </script>
  </Fragment>

  <Hero />
  <AboutJoeSection />
  <ServiceCardsGrid services={services} />
  <TestimonialCarousel testimonials={testimonials} />
  <CtaBlock />
</BaseLayout>