---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import CtaBlock from '@/components/sections/CtaBlock.astro';
import SocialShareButtons from '@/components/SocialShareButtons.astro';
import { Image } from 'astro:assets';
import { generateArticleSchema } from '@/utils/seo';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const pageSeo = {
  title: post.data.seo.title,
  description: post.data.seo.description,
  keywords: post.data.seo.keywords,
  ogImage: post.data.image?.url,
};
---

<BaseLayout seo={pageSeo}>
  <Fragment slot="head-schema">
    <script type="application/ld+json">
      {JSON.stringify(generateArticleSchema(Astro, post))}
    </script>
  </Fragment>

  <article class="container mx-auto px-4 py-16 md:py-24 max-w-4xl">
    <header class="mb-12 text-center">
      <time class="text-sm text-text-muted">
        {post.data.pubDate.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}
      </time>
      <h1 class="text-4xl md:text-5xl font-heading font-bold mt-2 mb-4 text-text-dark">
        {post.data.title}
      </h1>
      <p class="text-xl text-text-muted mb-6">
        {post.data.description}
      </p>
      {post.data.author && (
        <p class="text-text-dark font-medium">By {post.data.author}</p>
      )}
    </header>

    {post.data.image && (
      <div class="mb-12 rounded-lg shadow-xl overflow-hidden">
        <Image
          src={post.data.image.url}
          alt={post.data.image.alt}
          width={1000}
          height={600}
          class="w-full h-auto object-cover"
          loading="eager"
        />
      </div>
    )}

    <div class="prose prose-lg max-w-none text-text-dark">
      <Content />
    </div>

    <footer class="mt-16 pt-8 border-t border-border">
      <div class="flex flex-wrap gap-2 mb-8">
        {post.data.tags.map((tag) => (
          <a href={`/blog/tag/${tag}`} class="text-sm bg-gray-100 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors text-text-muted">
            #{tag}
          </a>
        ))}
      </div>

      <div class="flex flex-col sm:flex-row items-center justify-between gap-6">
        <SocialShareButtons
          title={post.data.title}
          text={post.data.description}
          url={String(new URL(`/blog/${post.slug}`, Astro.site))}
        />
        <a href="/contact" class="btn btn-primary btn-md">
          Book Your Free Consultation &rarr;
        </a>
      </div>
    </footer>
  </article>

  <CtaBlock />
</BaseLayout>