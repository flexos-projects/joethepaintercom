---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import SocialShareButtons from '@components/blog/SocialShareButtons.astro'; // Assuming this component will be created
import Button from '@components/ui/Button.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const formattedPubDate = post.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
const formattedUpdatedDate = post.data.updatedDate?.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const pageCanonicalURL = new URL(`/blog/${post.slug}`, Astro.site);
const pageImage = post.data.image?.url ? new URL(post.data.image.url, Astro.site).href : undefined;
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  canonicalURL={pageCanonicalURL.href}
  ogImage={pageImage}
>
  <article class="container mx-auto px-4 py-12 md:py-16 lg:py-20 max-w-4xl">
    <header class="mb-10 lg:mb-12 text-center">
      <time datetime={post.data.pubDate.toISOString()} class="text-sm text-neutral-500 font-body">
        {formattedPubDate}
      </time>
      {post.data.updatedDate && (
        <time datetime={post.data.updatedDate.toISOString()} class="text-sm text-neutral-500 font-body ml-2">
          (Updated: {formattedUpdatedDate})
        </time>
      )}
      <h1 class="text-4xl lg:text-5xl font-heading font-bold text-neutral-800 mt-2">
        {post.data.title}
      </h1>
      <p class="text-lg text-neutral-500 font-body mt-4">
        {post.data.description}
      </p>
      {post.data.author && (
        <p class="mt-4 text-neutral-600 font-body text-sm">By <span class="font-semibold">{post.data.author}</span></p>
      )}
    </header>

    {post.data.image && (
      <div class="relative w-full aspect-video rounded-lg overflow-hidden mb-10 lg:mb-12 shadow-md">
        <Image
          src={post.data.image.url}
          alt={post.data.image.alt}
          widths={[600, 900, 1200]}
          sizes="(max-width: 768px) 100vw, 800px"
          class="w-full h-full object-cover"
          loading="eager"
          decoding="sync"
          fetchpriority="high"
        />
      </div>
    )}

    <div class="prose prose-lg max-w-none font-body text-neutral-800 leading-relaxed">
      <Content />
    </div>

    <footer class="mt-12 pt-8 border-t border-neutral-200">
      <div class="flex flex-wrap gap-2 mb-8">
        {post.data.tags.map((tag) => (
          <a
            href={`/blog?category=${tag}`}
            class="text-sm bg-neutral-100 text-neutral-600 px-3 py-1 rounded-full hover:bg-neutral-200 transition-colors duration-200 ease-in-out
                   focus:outline-none focus-visible:ring-1 focus-visible:ring-primary"
            aria-label={`View posts in ${tag} category`}
          >
            #{tag}
          </a>
        ))}
      </div>

      <div class="flex flex-col sm:flex-row items-center justify-between gap-6">
        <SocialShareButtons title={post.data.title} url={pageCanonicalURL.href} />
        <Button href="/contact" variant="primary" size="md" class="w-full sm:w-auto">
          Book Your Free Consultation
        </Button>
      </div>
    </footer>
  </article>
</BaseLayout>

<style is:global>
  /* Tailwind Typography plugin styles for markdown content */
  .prose h2, .prose h3, .prose h4 {
    font-family: var(--font-heading);
    color: var(--colors-neutral-800);
  }
  .prose h2 {
    font-size: var(--font-size-2xl);
    line-height: var(--line-height-2xl);
    font-weight: var(--font-semibold);
    margin-top: var(--spacing-8);
    margin-bottom: var(--spacing-4);
  }
  .prose h3 {
    font-size: var(--font-size-xl);
    line-height: var(--line-height-xl);
    font-weight: var(--font-semibold);
    margin-top: var(--spacing-6);
    margin-bottom: var(--spacing-3);
  }
  .prose p {
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    color: var(--colors-neutral-700);
    margin-bottom: var(--spacing-4);
  }
  .prose a {
    color: var(--colors-primary);
    text-decoration: underline;
    transition: color 0.2s ease-in-out;
  }
  .prose a:hover {
    color: var(--colors-primary-dark);
  }
  .prose ul, .prose ol {
    margin-left: var(--spacing-6);
    margin-bottom: var(--spacing-4);
    list-style-position: outside;
  }
  .prose ul li, .prose ol li {
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    line-height: var(--line-height-relaxed);
    color: var(--colors-neutral-700);
    margin-bottom: var(--spacing-2);
  }
  .prose img {
    border-radius: var(--border-radius-lg);
    margin-top: var(--spacing-8);
    margin-bottom: var(--spacing-8);
    box-shadow: var(--shadow-md);
    max-width: 100%;
    height: auto;
  }
  .prose strong {
    font-weight: var(--font-semibold);
    color: var(--colors-neutral-800);
  }
  .prose em {
    font-style: italic;
  }
  .prose blockquote {
    border-left: 4px solid var(--colors-neutral-200);
    padding-left: var(--spacing-4);
    font-style: italic;
    color: var(--colors-neutral-600);
    margin-top: var(--spacing-6);
    margin-bottom: var(--spacing-6);
  }
</style>