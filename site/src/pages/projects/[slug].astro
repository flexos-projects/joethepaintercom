---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import Button from '@/components/ui/Button.astro';
import BeforeAfterSlider from '@/components/BeforeAfterSlider.astro';
import RichTextContent from '@/components/RichTextContent.astro'; // Component to render RichText fields

export async function getStaticPaths() {
  const projects = await getCollection('projects', ({ data }) => data.published);
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await project.render();

const hasBeforeAndAfterImages = project.data.beforeImages && project.data.beforeImages.length > 0 && project.data.afterImages.length > 0;
---

<BaseLayout title={project.data.seo.title} description={project.data.seo.description}>
  <article class="container mx-auto px-4 py-12 md:py-16 lg:py-20 max-w-6xl">
    <header class="text-center mb-12">
      <h1 class="text-4xl lg:text-5xl font-heading font-bold text-text-dark mb-4">
        {project.data.title}
      </h1>
      <p class="text-lg text-text-muted">
        {project.data.location} &bull; Completed {project.data.projectDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' })}
      </p>
    </header>

    <section class="mb-12">
      {hasBeforeAndAfterImages ? (
        <div class="max-w-4xl mx-auto">
          <BeforeAfterSlider
            beforeImage={project.data.beforeImages![0]}
            afterImage={project.data.afterImages[0]}
            aspectRatio="16/9"
            width={1280}
            height={720}
          />
          <p class="text-center text-sm text-text-muted mt-4">Drag the slider to see the transformation!</p>
        </div>
      ) : (
        <div class="max-w-4xl mx-auto rounded-lg overflow-hidden shadow-md">
          <Image
            src={project.data.featuredImage.src}
            alt={project.data.featuredImage.alt}
            width={1280}
            height={720}
            class="w-full h-auto object-cover"
            loading="eager"
            densities={[1.5, 2]}
          />
          {project.data.featuredImage.caption && (
            <p class="text-center text-sm text-text-muted mt-2">{project.data.featuredImage.caption}</p>
          )}
        </div>
      )}
    </section>

    <section class="prose prose-lg max-w-3xl mx-auto text-text-dark">
      <h2 class="font-heading font-bold text-3xl lg:text-4xl mb-4">The Project Story</h2>
      <div class="mb-8">
        <h3 class="font-heading font-semibold text-2xl lg:text-3xl text-primary mb-2">The Challenge</h3>
        <RichTextContent content={project.data.challenge} class="text-text-dark text-base leading-relaxed" />
      </div>
      <div class="mb-8">
        <h3 class="font-heading font-semibold text-2xl lg:text-3xl text-primary mb-2">Joe's Solution</h3>
        <RichTextContent content={project.data.solution} class="text-text-dark text-base leading-relaxed" />
      </div>
      <div class="mb-8">
        <h3 class="font-heading font-semibold text-2xl lg:text-3xl text-primary mb-2">The Result</h3>
        <RichTextContent content={project.data.result} class="text-text-dark text-base leading-relaxed" />
      </div>

      {project.data.testimonial && (
        <blockquote class="border-l-4 border-accent pl-4 italic text-lg text-text-muted my-8">
          "{project.data.testimonial}"
          {project.data.clientName && <cite class="block mt-2 not-italic text-text-dark font-medium">- {project.data.clientName}</cite>}
        </blockquote>
      )}

      {project.data.afterImages.length > 1 && (
        <div class="mt-12">
          <h3 class="font-heading font-semibold text-2xl lg:text-3xl text-primary mb-6">More Views</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {project.data.afterImages.slice(hasBeforeAndAfterImages ? 1 : 0).map((img) => (
              <figure class="rounded-lg overflow-hidden shadow-md">
                <Image
                  src={img.src}
                  alt={img.alt}
                  width={600}
                  height={400}
                  class="w-full h-64 object-cover"
                  loading="lazy"
                  densities={[1.5, 2]}
                />
                {img.alt && <figcaption class="p-4 text-sm text-text-muted bg-surface">{img.alt}</figcaption>}
              </figure>
            ))}
          </div>
        </div>
      )}

      <div class="mt-12 text-center">
        <h3 class="font-heading font-semibold text-2xl lg:text-3xl text-text-dark mb-4">Ready for Your Own Transformation?</h3>
        <Button href="/consultation" variant="primary" size="lg" class="inline-flex">
          Book Your Free Consultation
        </Button>
      </div>
    </section>
  </article>
</BaseLayout>

<style is:global>
  /* Tailwind Typography plugin classes overrides to align with design tokens */
  .prose h1 { @apply text-text-dark font-heading font-bold text-4xl lg:text-5xl; }
  .prose h2 { @apply text-text-dark font-heading font-bold text-3xl lg:text-4xl; }
  .prose h3 { @apply text-text-dark font-heading font-semibold text-2xl lg:text-3xl; }
  .prose h4 { @apply text-text-dark font-body font-semibold text-xl lg:text-2xl; }
  .prose p { @apply text-text-dark text-base leading-relaxed; }
  .prose strong { @apply font-semibold text-text-dark; }
  .prose a { @apply text-primary hover:underline; }
  .prose ul, .prose ol { @apply list-disc list-inside; }
  .prose li { @apply text-text-dark; }
  .prose blockquote { @apply border-l-4 border-border pl-4 text-text-muted italic; }
  .prose img { @apply rounded-lg shadow-md mx-auto; }
</style>